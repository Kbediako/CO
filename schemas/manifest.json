{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://schemas.codex.openai.com/orchestrator/cli-manifest.json",
  "title": "Codex Orchestrator CLI Manifest",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "version",
    "task_id",
    "task_slug",
    "run_id",
    "parent_run_id",
    "pipeline_id",
    "pipeline_title",
    "runner",
    "approval_policy",
    "status",
    "status_detail",
    "started_at",
    "completed_at",
    "updated_at",
    "heartbeat_at",
    "heartbeat_interval_seconds",
    "heartbeat_stale_after_seconds",
    "artifact_root",
    "compat_path",
    "log_path",
    "summary",
    "metrics_recorded",
    "resume_token",
    "resume_events",
    "approvals",
    "commands",
    "child_runs",
    "run_summary_path",
    "instructions_hash",
    "instructions_sources"
  ],
  "properties": {
    "version": { "type": "integer", "minimum": 1 },
    "task_id": { "type": "string", "minLength": 1 },
    "task_slug": { "type": ["string", "null"] },
    "run_id": { "type": "string", "minLength": 1 },
    "parent_run_id": { "type": ["string", "null"] },
    "pipeline_id": { "type": "string", "minLength": 1 },
    "pipeline_title": { "type": "string", "minLength": 1 },
    "runner": { "type": "string", "const": "codex-cli" },
    "approval_policy": { "type": ["string", "null"] },
    "status": { "type": "string", "enum": ["queued", "in_progress", "succeeded", "failed", "cancelled"] },
    "status_detail": { "type": ["string", "null"] },
    "started_at": { "type": "string", "minLength": 1 },
    "completed_at": { "type": ["string", "null"] },
    "updated_at": { "type": "string", "minLength": 1 },
    "heartbeat_at": { "type": ["string", "null"] },
    "heartbeat_interval_seconds": { "type": "integer", "minimum": 1 },
    "heartbeat_stale_after_seconds": { "type": "integer", "minimum": 1 },
    "artifact_root": { "type": "string", "minLength": 1 },
    "compat_path": { "type": "string", "minLength": 1 },
    "log_path": { "type": "string", "minLength": 1 },
    "summary": { "type": ["string", "null"] },
    "metrics_recorded": { "type": "boolean" },
    "resume_token": { "type": "string", "minLength": 1 },
    "resume_events": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["timestamp", "actor", "reason", "outcome"],
        "additionalProperties": false,
        "properties": {
          "timestamp": { "type": "string", "minLength": 1 },
          "actor": { "type": "string", "minLength": 1 },
          "reason": { "type": "string", "minLength": 1 },
          "outcome": { "type": "string", "enum": ["accepted", "blocked"] },
          "detail": { "type": ["string", "null"] }
        }
      }
    },
    "approvals": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["actor", "timestamp"],
        "additionalProperties": false,
        "properties": {
          "actor": { "type": "string", "minLength": 1 },
          "timestamp": { "type": "string", "minLength": 1 },
          "reason": { "type": ["string", "null"] }
        }
      }
    },
    "handles": {
      "type": ["array", "null"],
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": [
          "handle_id",
          "correlation_id",
          "stage_id",
          "pipeline_id",
          "status",
          "frame_count",
          "latest_sequence",
          "created_at"
        ],
        "properties": {
          "handle_id": { "type": "string", "minLength": 1 },
          "correlation_id": { "type": "string", "minLength": 1 },
          "stage_id": { "type": ["string", "null"] },
          "pipeline_id": { "type": "string", "minLength": 1 },
          "status": { "type": "string", "enum": ["open", "closed"] },
          "frame_count": { "type": "integer", "minimum": 0 },
          "latest_sequence": { "type": "integer", "minimum": 0 },
          "created_at": { "type": "string", "minLength": 1 },
          "metadata": { "type": ["object", "null"] }
        }
      }
    },
    "commands": {
      "type": "array",
      "items": {
        "type": "object",
        "required": [
          "index",
          "id",
          "title",
          "command",
          "kind",
          "status",
          "started_at",
          "completed_at",
          "exit_code",
          "summary",
          "log_path",
          "error_file",
          "sub_run_id"
        ],
        "additionalProperties": false,
        "properties": {
          "index": { "type": "integer", "minimum": 1 },
          "id": { "type": "string", "minLength": 1 },
          "title": { "type": "string", "minLength": 1 },
          "command": { "type": ["string", "null"] },
          "kind": { "type": "string", "enum": ["command", "subpipeline"] },
          "status": { "type": "string", "enum": ["pending", "running", "succeeded", "failed", "skipped"] },
          "started_at": { "type": ["string", "null"] },
          "completed_at": { "type": ["string", "null"] },
          "exit_code": { "type": ["integer", "null"] },
          "summary": { "type": ["string", "null"] },
          "log_path": { "type": ["string", "null"] },
          "error_file": { "type": ["string", "null"] },
          "sub_run_id": { "type": ["string", "null"] }
        }
      }
    },
    "child_runs": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["run_id", "pipeline_id", "status", "manifest"],
        "additionalProperties": false,
        "properties": {
          "run_id": { "type": "string", "minLength": 1 },
          "pipeline_id": { "type": "string", "minLength": 1 },
          "status": { "type": "string", "enum": ["queued", "in_progress", "succeeded", "failed", "cancelled"] },
          "manifest": { "type": "string", "minLength": 1 }
        }
      }
    },
    "run_summary_path": { "type": ["string", "null"] },
    "control_plane": {
      "type": ["object", "null"],
      "additionalProperties": false,
      "required": ["schema_id", "schema_version", "request_id", "validation"],
      "properties": {
        "schema_id": { "type": "string", "minLength": 1 },
        "schema_version": { "type": "string", "minLength": 1 },
        "request_id": { "type": "string", "minLength": 1 },
        "validation": {
          "type": "object",
          "additionalProperties": false,
          "required": ["mode", "status", "timestamp", "errors"],
          "properties": {
            "mode": { "type": "string", "enum": ["shadow", "enforce"] },
            "status": { "type": "string", "enum": ["passed", "failed"] },
            "timestamp": { "type": "string", "minLength": 1 },
            "errors": {
              "type": "array",
              "items": {
                "type": "object",
                "additionalProperties": false,
                "required": ["path", "message"],
                "properties": {
                  "path": { "type": "string", "minLength": 1 },
                  "message": { "type": "string", "minLength": 1 },
                  "value": {},
                  "expected": { "type": ["string", "null"] }
                }
              }
            }
          }
        },
        "drift": {
          "type": ["object", "null"],
          "additionalProperties": false,
          "required": ["report_path", "total_samples", "invalid_samples", "invalid_rate", "last_sampled_at", "mode"],
          "properties": {
            "report_path": { "type": ["string", "null"] },
            "total_samples": { "type": "integer", "minimum": 0 },
            "invalid_samples": { "type": "integer", "minimum": 0 },
            "invalid_rate": { "type": "number", "minimum": 0 },
            "last_sampled_at": { "type": ["string", "null"] },
            "mode": { "type": "string", "enum": ["shadow", "enforce"] }
          }
        },
        "enforcement": {
          "type": ["object", "null"],
          "additionalProperties": false,
          "required": ["enabled", "activated_at"],
          "properties": {
            "enabled": { "type": "boolean" },
            "activated_at": { "type": ["string", "null"] }
          }
        }
      }
    },
    "scheduler": {
      "type": ["object", "null"],
      "additionalProperties": false,
      "required": ["mode", "requested_at", "min_instances", "max_instances", "recovery", "assignments"],
      "properties": {
        "mode": { "type": "string", "const": "multi-instance" },
        "requested_at": { "type": "string", "minLength": 1 },
        "min_instances": { "type": "integer", "minimum": 1 },
        "max_instances": { "type": "integer", "minimum": 1 },
        "recovery": {
          "type": "object",
          "additionalProperties": false,
          "required": ["heartbeat_interval_seconds", "missing_heartbeat_timeout_seconds", "max_retries"],
          "properties": {
            "heartbeat_interval_seconds": { "type": "integer", "minimum": 1 },
            "missing_heartbeat_timeout_seconds": { "type": "integer", "minimum": 1 },
            "max_retries": { "type": "integer", "minimum": 0 }
          }
        },
        "assignments": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["instance_id", "capability", "status", "assigned_at", "completed_at", "metadata", "attempts"],
            "properties": {
              "instance_id": { "type": "string", "minLength": 1 },
              "capability": { "type": "string", "minLength": 1 },
              "status": {
                "type": "string",
                "enum": ["assigned", "running", "succeeded", "failed", "recovered"]
              },
              "assigned_at": { "type": "string", "minLength": 1 },
              "completed_at": { "type": ["string", "null"] },
              "metadata": {
                "type": "object",
                "additionalProperties": false,
                "required": ["weight", "maxConcurrency"],
                "properties": {
                  "weight": { "type": "number", "minimum": 0 },
                  "maxConcurrency": { "type": "integer", "minimum": 1 }
                }
              },
              "attempts": {
                "type": "array",
                "items": {
                  "type": "object",
                  "additionalProperties": false,
                  "required": ["number", "assigned_at", "started_at", "completed_at", "status", "recovery_checkpoints"],
                  "properties": {
                    "number": { "type": "integer", "minimum": 1 },
                    "assigned_at": { "type": "string", "minLength": 1 },
                    "started_at": { "type": ["string", "null"] },
                    "completed_at": { "type": ["string", "null"] },
                    "status": {
                      "type": "string",
                      "enum": ["pending", "running", "completed", "failed", "requeued"]
                    },
                    "recovery_checkpoints": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "additionalProperties": false,
                        "required": ["timestamp", "reason", "action"],
                        "properties": {
                          "timestamp": { "type": "string", "minLength": 1 },
                          "reason": {
                            "type": "string",
                            "enum": ["missed-heartbeat", "manual", "auto"]
                          },
                          "action": {
                            "type": "string",
                            "enum": ["requeue", "escalate", "ack"]
                          },
                          "detail": { "type": ["string", "null"] }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "privacy": {
      "type": ["object", "null"],
      "additionalProperties": false,
      "required": ["mode", "decisions", "totals"],
      "properties": {
        "mode": { "type": "string", "enum": ["shadow", "enforce"] },
        "decisions": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["handle_id", "sequence", "action", "timestamp", "stage_id"],
            "properties": {
              "handle_id": { "type": "string", "minLength": 1 },
              "sequence": { "type": "integer", "minimum": 0 },
              "action": { "type": "string", "enum": ["allow", "redact", "block"] },
              "rule": { "type": ["string", "null"] },
              "reason": { "type": ["string", "null"] },
              "timestamp": { "type": "string", "minLength": 1 },
              "stage_id": { "type": ["string", "null"] }
            }
          }
        },
        "totals": {
          "type": "object",
          "additionalProperties": false,
          "required": ["total_frames", "redacted_frames", "blocked_frames", "allowed_frames"],
          "properties": {
            "total_frames": { "type": "integer", "minimum": 0 },
            "redacted_frames": { "type": "integer", "minimum": 0 },
            "blocked_frames": { "type": "integer", "minimum": 0 },
            "allowed_frames": { "type": "integer", "minimum": 0 }
          }
        }
      }
    },
    "instructions_hash": { "type": ["string", "null"] },
    "instructions_sources": {
      "type": "array",
      "items": { "type": "string", "minLength": 1 }
    }
  }
}
