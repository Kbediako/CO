{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://schemas.codex.openai.com/orchestrator/cli-manifest.json",
  "title": "Codex Orchestrator CLI Manifest",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "version",
    "task_id",
    "task_slug",
    "run_id",
    "parent_run_id",
    "pipeline_id",
    "pipeline_title",
    "runner",
    "approval_policy",
    "status",
    "status_detail",
    "started_at",
    "completed_at",
    "updated_at",
    "heartbeat_at",
    "heartbeat_interval_seconds",
    "heartbeat_stale_after_seconds",
    "artifact_root",
    "compat_path",
    "log_path",
    "summary",
    "metrics_recorded",
    "resume_token",
    "resume_events",
    "approvals",
    "commands",
    "child_runs",
    "run_summary_path",
    "plan_target_id",
    "instructions_hash",
    "instructions_sources"
  ],
  "properties": {
    "version": { "type": "integer", "minimum": 1 },
    "task_id": { "type": "string", "minLength": 1 },
    "task_slug": { "type": ["string", "null"] },
    "run_id": { "type": "string", "minLength": 1 },
    "parent_run_id": { "type": ["string", "null"] },
    "pipeline_id": { "type": "string", "minLength": 1 },
    "pipeline_title": { "type": "string", "minLength": 1 },
    "runner": { "type": "string", "const": "codex-cli" },
    "approval_policy": { "type": ["string", "null"] },
    "status": { "type": "string", "enum": ["queued", "in_progress", "succeeded", "failed", "cancelled"] },
    "status_detail": { "type": ["string", "null"] },
    "started_at": { "type": "string", "minLength": 1 },
    "completed_at": { "type": ["string", "null"] },
    "updated_at": { "type": "string", "minLength": 1 },
    "heartbeat_at": { "type": ["string", "null"] },
    "heartbeat_interval_seconds": { "type": "integer", "minimum": 1 },
    "heartbeat_stale_after_seconds": { "type": "integer", "minimum": 1 },
    "artifact_root": { "type": "string", "minLength": 1 },
    "compat_path": { "type": "string", "minLength": 1 },
    "log_path": { "type": "string", "minLength": 1 },
    "summary": { "type": ["string", "null"] },
    "metrics_recorded": { "type": "boolean" },
    "resume_token": { "type": "string", "minLength": 1 },
    "resume_events": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["timestamp", "actor", "reason", "outcome"],
        "additionalProperties": false,
        "properties": {
          "timestamp": { "type": "string", "minLength": 1 },
          "actor": { "type": "string", "minLength": 1 },
          "reason": { "type": "string", "minLength": 1 },
          "outcome": { "type": "string", "enum": ["accepted", "blocked"] },
          "detail": { "type": ["string", "null"] }
        }
      }
    },
    "approvals": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["actor", "timestamp"],
        "additionalProperties": false,
        "properties": {
          "actor": { "type": "string", "minLength": 1 },
          "timestamp": { "type": "string", "minLength": 1 },
          "reason": { "type": ["string", "null"] }
        }
      }
    },
    "handles": {
      "type": ["array", "null"],
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": [
          "handle_id",
          "correlation_id",
          "stage_id",
          "pipeline_id",
          "status",
          "frame_count",
          "latest_sequence",
          "created_at"
        ],
        "properties": {
          "handle_id": { "type": "string", "minLength": 1 },
          "correlation_id": { "type": "string", "minLength": 1 },
          "stage_id": { "type": ["string", "null"] },
          "pipeline_id": { "type": "string", "minLength": 1 },
          "status": { "type": "string", "enum": ["open", "closed"] },
          "frame_count": { "type": "integer", "minimum": 0 },
          "latest_sequence": { "type": "integer", "minimum": 0 },
          "created_at": { "type": "string", "minLength": 1 },
          "metadata": { "type": ["object", "null"] }
        }
      }
    },
    "commands": {
      "type": "array",
      "items": {
        "type": "object",
        "required": [
          "index",
          "id",
          "title",
          "command",
          "kind",
          "status",
          "started_at",
          "completed_at",
          "exit_code",
          "summary",
          "log_path",
          "error_file",
          "sub_run_id"
        ],
        "additionalProperties": false,
        "properties": {
          "index": { "type": "integer", "minimum": 1 },
          "id": { "type": "string", "minLength": 1 },
          "title": { "type": "string", "minLength": 1 },
          "command": { "type": ["string", "null"] },
          "kind": { "type": "string", "enum": ["command", "subpipeline"] },
          "status": { "type": "string", "enum": ["pending", "running", "succeeded", "failed", "skipped"] },
          "started_at": { "type": ["string", "null"] },
          "completed_at": { "type": ["string", "null"] },
          "exit_code": { "type": ["integer", "null"] },
          "summary": { "type": ["string", "null"] },
          "log_path": { "type": ["string", "null"] },
          "error_file": { "type": ["string", "null"] },
          "sub_run_id": { "type": ["string", "null"] }
        }
      }
    },
    "collab_tool_calls": {
      "type": ["array", "null"],
      "items": { "$ref": "#/definitions/collabToolCall" }
    },
    "child_runs": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["run_id", "pipeline_id", "status", "manifest"],
        "additionalProperties": false,
        "properties": {
          "run_id": { "type": "string", "minLength": 1 },
          "pipeline_id": { "type": "string", "minLength": 1 },
          "status": { "type": "string", "enum": ["queued", "in_progress", "succeeded", "failed", "cancelled"] },
          "manifest": { "type": "string", "minLength": 1 }
        }
      }
    },
    "run_summary_path": { "type": ["string", "null"] },
    "plan_target_id": { "type": ["string", "null"] },
    "control_plane": {
      "type": ["object", "null"],
      "additionalProperties": false,
      "required": ["schema_id", "schema_version", "request_id", "validation"],
      "properties": {
        "schema_id": { "type": "string", "minLength": 1 },
        "schema_version": { "type": "string", "minLength": 1 },
        "request_id": { "type": "string", "minLength": 1 },
        "validation": {
          "type": "object",
          "additionalProperties": false,
          "required": ["mode", "status", "timestamp", "errors"],
          "properties": {
            "mode": { "type": "string", "enum": ["shadow", "enforce"] },
            "status": { "type": "string", "enum": ["passed", "failed"] },
            "timestamp": { "type": "string", "minLength": 1 },
            "errors": {
              "type": "array",
              "items": {
                "type": "object",
                "additionalProperties": false,
                "required": ["path", "message"],
                "properties": {
                  "path": { "type": "string", "minLength": 1 },
                  "message": { "type": "string", "minLength": 1 },
                  "value": {},
                  "expected": { "type": ["string", "null"] }
                }
              }
            }
          }
        },
        "drift": {
          "type": ["object", "null"],
          "additionalProperties": false,
          "required": ["report_path", "total_samples", "invalid_samples", "invalid_rate", "last_sampled_at", "mode"],
          "properties": {
            "report_path": { "type": ["string", "null"] },
            "total_samples": { "type": "integer", "minimum": 0 },
            "invalid_samples": { "type": "integer", "minimum": 0 },
            "invalid_rate": { "type": "number", "minimum": 0 },
            "last_sampled_at": { "type": ["string", "null"] },
            "mode": { "type": "string", "enum": ["shadow", "enforce"] }
          }
        },
        "enforcement": {
          "type": ["object", "null"],
          "additionalProperties": false,
          "required": ["enabled", "activated_at"],
          "properties": {
            "enabled": { "type": "boolean" },
            "activated_at": { "type": ["string", "null"] }
          }
        }
      }
    },
    "guardrails_required": { "type": ["boolean", "null"] },
    "scheduler": {
      "type": ["object", "null"],
      "additionalProperties": false,
      "required": ["mode", "requested_at", "min_instances", "max_instances", "recovery", "assignments"],
      "properties": {
        "mode": { "type": "string", "const": "multi-instance" },
        "requested_at": { "type": "string", "minLength": 1 },
        "min_instances": { "type": "integer", "minimum": 1 },
        "max_instances": { "type": "integer", "minimum": 1 },
        "recovery": {
          "type": "object",
          "additionalProperties": false,
          "required": ["heartbeat_interval_seconds", "missing_heartbeat_timeout_seconds", "max_retries"],
          "properties": {
            "heartbeat_interval_seconds": { "type": "integer", "minimum": 1 },
            "missing_heartbeat_timeout_seconds": { "type": "integer", "minimum": 1 },
            "max_retries": { "type": "integer", "minimum": 0 }
          }
        },
        "assignments": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["instance_id", "capability", "status", "assigned_at", "completed_at", "metadata", "attempts"],
            "properties": {
              "instance_id": { "type": "string", "minLength": 1 },
              "capability": { "type": "string", "minLength": 1 },
              "status": {
                "type": "string",
                "enum": ["assigned", "running", "succeeded", "failed", "recovered"]
              },
              "assigned_at": { "type": "string", "minLength": 1 },
              "completed_at": { "type": ["string", "null"] },
              "metadata": {
                "type": "object",
                "additionalProperties": false,
                "required": ["weight", "maxConcurrency"],
                "properties": {
                  "weight": { "type": "number", "minimum": 0 },
                  "maxConcurrency": { "type": "integer", "minimum": 1 }
                }
              },
              "attempts": {
                "type": "array",
                "items": {
                  "type": "object",
                  "additionalProperties": false,
                  "required": ["number", "assigned_at", "started_at", "completed_at", "status", "recovery_checkpoints"],
                  "properties": {
                    "number": { "type": "integer", "minimum": 1 },
                    "assigned_at": { "type": "string", "minLength": 1 },
                    "started_at": { "type": ["string", "null"] },
                    "completed_at": { "type": ["string", "null"] },
                    "status": {
                      "type": "string",
                      "enum": ["pending", "running", "completed", "failed", "requeued"]
                    },
                    "recovery_checkpoints": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "additionalProperties": false,
                        "required": ["timestamp", "reason", "action"],
                        "properties": {
                          "timestamp": { "type": "string", "minLength": 1 },
                          "reason": {
                            "type": "string",
                            "enum": ["missed-heartbeat", "manual", "auto"]
                          },
                          "action": {
                            "type": "string",
                            "enum": ["requeue", "escalate", "ack"]
                          },
                          "detail": { "type": ["string", "null"] }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "cloud_execution": {
      "type": ["object", "null"],
      "additionalProperties": false,
      "required": [
        "task_id",
        "environment_id",
        "status",
        "status_url",
        "submitted_at",
        "completed_at",
        "last_polled_at",
        "poll_count",
        "poll_interval_seconds",
        "timeout_seconds",
        "attempts",
        "diff_path",
        "diff_url",
        "diff_status",
        "apply_status",
        "log_path",
        "error"
      ],
      "properties": {
        "task_id": { "type": ["string", "null"] },
        "environment_id": { "type": ["string", "null"] },
        "status": {
          "type": "string",
          "enum": ["queued", "running", "ready", "error", "failed", "cancelled", "unknown"]
        },
        "status_url": { "type": ["string", "null"] },
        "submitted_at": { "type": ["string", "null"] },
        "completed_at": { "type": ["string", "null"] },
        "last_polled_at": { "type": ["string", "null"] },
        "poll_count": { "type": "integer", "minimum": 0 },
        "poll_interval_seconds": { "type": "integer", "minimum": 1 },
        "timeout_seconds": { "type": "integer", "minimum": 1 },
        "attempts": { "type": "integer", "minimum": 1 },
        "diff_path": { "type": ["string", "null"] },
        "diff_url": { "type": ["string", "null"] },
        "diff_status": { "type": "string", "enum": ["pending", "available", "unavailable"] },
        "apply_status": { "type": "string", "enum": ["not_requested", "succeeded", "failed"] },
        "log_path": { "type": ["string", "null"] },
        "error": { "type": ["string", "null"] }
      }
    },
    "privacy": {
      "type": ["object", "null"],
      "additionalProperties": false,
      "required": ["mode", "decisions", "totals"],
      "properties": {
        "mode": { "type": "string", "enum": ["shadow", "enforce"] },
        "decisions": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["handle_id", "sequence", "action", "timestamp", "stage_id"],
            "properties": {
              "handle_id": { "type": "string", "minLength": 1 },
              "sequence": { "type": "integer", "minimum": 0 },
              "action": { "type": "string", "enum": ["allow", "redact", "block"] },
              "rule": { "type": ["string", "null"] },
              "reason": { "type": ["string", "null"] },
              "timestamp": { "type": "string", "minLength": 1 },
              "stage_id": { "type": ["string", "null"] }
            }
          }
        },
        "totals": {
          "type": "object",
          "additionalProperties": false,
          "required": ["total_frames", "redacted_frames", "blocked_frames", "allowed_frames"],
          "properties": {
            "total_frames": { "type": "integer", "minimum": 0 },
            "redacted_frames": { "type": "integer", "minimum": 0 },
            "blocked_frames": { "type": "integer", "minimum": 0 },
            "allowed_frames": { "type": "integer", "minimum": 0 }
          }
        },
        "log_path": { "type": ["string", "null"] }
      }
    },
    "instructions_hash": { "type": ["string", "null"] },
    "instructions_sources": {
      "type": "array",
      "items": { "type": "string", "minLength": 1 }
    },
    "prompt_packs": {
      "type": ["array", "null"],
      "items": {
        "type": "object",
        "required": ["id", "domain", "stamp", "experience_slots", "sources"],
        "additionalProperties": false,
        "properties": {
          "id": { "type": "string", "minLength": 1 },
          "domain": { "type": "string", "minLength": 1 },
          "stamp": { "type": "string", "minLength": 1 },
          "experience_slots": { "type": "integer", "minimum": 0 },
          "sources": {
            "type": "array",
            "items": { "type": "string", "minLength": 1 }
          },
          "experiences": {
            "type": ["array", "null"],
            "items": { "type": "string", "minLength": 1 }
          }
        }
      }
    },
    "tfgrpo": {
      "type": ["object", "null"],
      "additionalProperties": false,
      "properties": {
        "epoch": { "type": ["integer", "null"] },
        "group_id": { "type": ["string", "null"] },
        "group_size": { "type": ["integer", "null"], "minimum": 0 },
        "tool_metrics": {
          "type": ["object", "null"],
          "additionalProperties": false,
          "required": ["tool_calls", "token_total", "cost_usd", "latency_ms", "per_tool"],
          "properties": {
            "tool_calls": { "type": "integer", "minimum": 0 },
            "token_total": { "type": "number", "minimum": 0 },
            "cost_usd": { "type": "number", "minimum": 0 },
            "latency_ms": { "type": "number", "minimum": 0 },
            "per_tool": {
              "type": "array",
              "items": {
                "type": "object",
                "required": [
                  "tool",
                  "tokens",
                  "cost_usd",
                  "latency_ms",
                  "attempts",
                  "status",
                  "sandbox_state"
                ],
                "additionalProperties": false,
                "properties": {
                  "tool": { "type": "string", "minLength": 1 },
                  "tokens": { "type": "number", "minimum": 0 },
                  "cost_usd": { "type": "number", "minimum": 0 },
                  "latency_ms": { "type": "number", "minimum": 0 },
                  "attempts": { "type": "integer", "minimum": 1 },
                  "status": { "type": "string", "enum": ["succeeded", "failed"] },
                  "sandbox_state": { "type": "string", "enum": ["sandboxed", "escalated", "failed"] }
                }
              }
            }
          }
        },
        "experiences": {
          "type": ["object", "null"],
          "additionalProperties": false,
          "required": ["ids", "written", "manifest_path"],
          "properties": {
            "ids": {
              "type": "array",
              "items": { "type": "string", "minLength": 1 }
            },
            "written": { "type": "integer", "minimum": 0 },
            "manifest_path": { "type": ["string", "null"] }
          }
        }
      }
    },
    "learning": {
      "type": ["object", "null"],
      "additionalProperties": false,
      "properties": {
        "snapshot": {
          "type": ["object", "null"],
          "additionalProperties": false,
          "required": [
            "tag",
            "commit_sha",
            "tarball_path",
            "tarball_digest",
            "storage_path",
            "retention_days",
            "status",
            "attempts",
            "created_at"
          ],
          "properties": {
            "tag": { "type": "string", "minLength": 1 },
            "commit_sha": { "type": "string", "minLength": 1 },
            "tarball_path": { "type": "string", "minLength": 1 },
            "tarball_digest": { "type": "string", "minLength": 1 },
            "storage_path": { "type": "string", "minLength": 1 },
            "retention_days": { "type": "integer", "minimum": 1 },
            "status": { "type": "string", "enum": ["pending", "captured", "snapshot_failed", "stalled_snapshot"] },
            "attempts": { "type": "integer", "minimum": 0 },
            "created_at": { "type": "string", "minLength": 1 },
            "last_error": { "type": ["string", "null"] },
            "git_status_path": { "type": ["string", "null"] },
            "git_log_path": { "type": ["string", "null"] }
          }
        },
        "queue": {
          "type": ["object", "null"],
          "additionalProperties": false,
          "required": ["snapshot_id", "manifest_path", "enqueued_at", "payload_path", "status"],
          "properties": {
            "snapshot_id": { "type": "string", "minLength": 1 },
            "diff_path": { "type": ["string", "null"] },
            "prompt_path": { "type": ["string", "null"] },
            "execution_history_path": { "type": ["string", "null"] },
            "manifest_path": { "type": "string", "minLength": 1 },
            "enqueued_at": { "type": "string", "minLength": 1 },
            "payload_path": { "type": "string", "minLength": 1 },
            "status": { "type": "string", "enum": ["queued", "failed"] }
          }
        },
        "scenario": {
          "type": ["object", "null"],
          "additionalProperties": false,
          "required": ["path", "generated_at", "source", "status", "attempts"],
          "properties": {
            "path": { "type": ["string", "null"] },
            "generated_at": { "type": ["string", "null"] },
            "source": { "type": "string", "enum": ["execution_history", "prompt", "diff", "template", "manual"] },
            "status": { "type": "string", "enum": ["pending", "synthesized", "needs_manual_scenario"] },
            "attempts": { "type": "integer", "minimum": 0 },
            "partial_path": { "type": ["string", "null"] },
            "manual_template": { "type": ["string", "null"] },
            "approver": { "type": ["string", "null"] },
            "reason": { "type": ["string", "null"] }
          }
        },
        "validation": {
          "type": ["object", "null"],
          "additionalProperties": false,
          "properties": {
            "mode": { "type": "string", "enum": ["per-task", "grouped"] },
            "grouping": {
              "type": ["object", "null"],
              "additionalProperties": false,
              "required": ["id", "members"],
              "properties": {
                "id": { "type": "string", "minLength": 1 },
                "members": { "type": "array", "items": { "type": "string", "minLength": 1 } },
                "window_hours": { "type": ["number", "null"] }
              }
            },
            "status": {
              "type": "string",
              "enum": ["pending", "validated", "snapshot_failed", "stalled_snapshot", "needs_manual_scenario"]
            },
            "reason": { "type": ["string", "null"] },
            "log_path": { "type": ["string", "null"] },
            "last_error": { "type": ["string", "null"] },
            "git_status_path": { "type": ["string", "null"] },
            "git_log_path": { "type": ["string", "null"] }
          }
        },
        "crystalizer": {
          "type": ["object", "null"],
          "additionalProperties": false,
          "required": ["candidate_path", "model", "prompt_pack", "prompt_pack_stamp", "budget_usd", "cost_usd", "status", "created_at"],
          "properties": {
            "candidate_path": { "type": ["string", "null"] },
            "model": { "type": "string", "minLength": 1 },
            "prompt_pack": { "type": "string", "minLength": 1 },
            "prompt_pack_stamp": { "type": ["string", "null"] },
            "budget_usd": { "type": "number", "minimum": 0 },
            "cost_usd": { "type": ["number", "null"] },
            "status": { "type": "string", "enum": ["pending", "succeeded", "skipped", "failed"] },
            "error": { "type": ["string", "null"] },
            "created_at": { "type": "string", "minLength": 1 }
          }
        },
        "alerts": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["type", "channel", "target", "message", "created_at"],
            "properties": {
              "type": { "type": "string", "enum": ["snapshot_failed", "stalled_snapshot", "needs_manual_scenario", "budget_exceeded"] },
              "channel": { "type": "string", "enum": ["slack", "pagerduty"] },
              "target": { "type": "string", "minLength": 1 },
              "message": { "type": "string", "minLength": 1 },
              "created_at": { "type": "string", "minLength": 1 },
              "severity": { "type": ["string", "null"] }
            }
          }
        },
        "approvals": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["actor", "timestamp", "state"],
            "properties": {
              "actor": { "type": "string", "minLength": 1 },
              "timestamp": { "type": "string", "minLength": 1 },
              "reason": { "type": ["string", "null"] },
              "state": { "type": "string", "enum": ["stalled_snapshot", "needs_manual_scenario", "requeue"] }
            }
          }
        },
        "review": {
          "type": ["object", "null"],
          "additionalProperties": false,
          "required": ["rejections", "latency_ms", "updated_at"],
          "properties": {
            "rejections": { "type": "integer", "minimum": 0 },
            "latency_ms": { "type": ["number", "null"] },
            "last_reviewer": { "type": ["string", "null"] },
            "updated_at": { "type": "string", "minLength": 1 }
          }
        },
        "regressions": {
          "type": ["object", "null"],
          "additionalProperties": false,
          "required": ["detected"],
          "properties": {
            "detected": { "type": "integer", "minimum": 0 },
            "detail_path": { "type": ["string", "null"] }
          }
        },
        "pattern_hygiene": {
          "type": ["object", "null"],
          "additionalProperties": false,
          "required": ["promoted", "deprecated", "updated_at"],
          "properties": {
            "promoted": { "type": "integer", "minimum": 0 },
            "deprecated": { "type": "integer", "minimum": 0 },
            "notes": { "type": ["array", "null"], "items": { "type": "string" } },
            "updated_at": { "type": "string", "minLength": 1 }
          }
        },
        "throughput": {
          "type": ["object", "null"],
          "additionalProperties": false,
          "required": ["candidates", "active", "deprecated", "updated_at"],
          "properties": {
            "candidates": { "type": "integer", "minimum": 0 },
            "active": { "type": "integer", "minimum": 0 },
            "deprecated": { "type": "integer", "minimum": 0 },
            "updated_at": { "type": "string", "minLength": 1 }
          }
        }
      }
    },
    "guardrail_status": {
      "type": "object",
      "additionalProperties": false,
      "required": ["present", "recommendation", "summary", "computed_at", "counts"],
      "properties": {
        "present": { "type": "boolean" },
        "recommendation": { "type": ["string", "null"] },
        "summary": { "type": "string", "minLength": 1 },
        "computed_at": { "type": "string", "minLength": 1 },
        "counts": {
          "type": "object",
          "additionalProperties": false,
          "required": ["total", "succeeded", "failed", "skipped", "other"],
          "properties": {
            "total": { "type": "integer", "minimum": 0 },
            "succeeded": { "type": "integer", "minimum": 0 },
            "failed": { "type": "integer", "minimum": 0 },
            "skipped": { "type": "integer", "minimum": 0 },
            "other": { "type": "integer", "minimum": 0 }
          }
        }
      }
    },
    "toolRuns": {
      "type": ["array", "null"],
      "items": { "$ref": "#/definitions/toolRun" }
    },
    "design_artifacts": {
      "type": ["array", "null"],
      "items": { "$ref": "#/definitions/designArtifact" }
    },
    "design_artifacts_summary": {
      "anyOf": [
        { "type": "null" },
        { "$ref": "#/definitions/designArtifactsSummary" }
      ]
    },
    "design_config_snapshot": { "type": ["object", "null"] },
    "design_toolkit_artifacts": {
      "type": ["array", "null"],
      "items": { "$ref": "#/definitions/designToolkitArtifact" }
    },
    "design_toolkit_summary": {
      "anyOf": [
        { "type": "null" },
        { "$ref": "#/definitions/designToolkitSummary" }
      ]
    },
    "design_plan": {
      "anyOf": [
        { "type": "null" },
        { "$ref": "#/definitions/designPlan" }
      ]
    },
    "design_guardrail": {
      "anyOf": [
        { "type": "null" },
        { "$ref": "#/definitions/designGuardrail" }
      ]
    },
    "design_history": {
      "anyOf": [
        { "type": "null" },
        { "$ref": "#/definitions/designHistory" }
      ]
    },
    "design_style_profile": {
      "anyOf": [
        { "type": "null" },
        { "$ref": "#/definitions/designStyleProfile" }
      ]
    },
    "design_metrics": {
      "anyOf": [
        { "type": "null" },
        { "$ref": "#/definitions/designMetrics" }
      ]
    }
  },
  "definitions": {
    "toolRun": {
      "type": "object",
      "required": [
        "id",
        "tool",
        "approvalSource",
        "retryCount",
        "sandboxState",
        "status",
        "startedAt",
        "completedAt",
        "attemptCount"
      ],
      "additionalProperties": false,
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "tool": { "type": "string", "minLength": 1 },
        "approvalSource": { "type": "string", "enum": ["not-required", "cache", "prompt"] },
        "retryCount": { "type": "integer", "minimum": 0 },
        "sandboxState": { "type": "string", "enum": ["sandboxed", "escalated", "failed"] },
        "status": { "type": "string", "enum": ["succeeded", "failed"] },
        "startedAt": { "type": "string", "minLength": 1 },
        "completedAt": { "type": "string", "minLength": 1 },
        "attemptCount": { "type": "integer", "minimum": 1 },
        "metadata": { "type": ["object", "null"] },
        "events": {
          "type": ["array", "null"],
          "items": { "$ref": "#/definitions/toolRunEvent" }
        }
      }
    },
    "toolRunEvent": {
      "type": "object",
      "required": ["type", "correlationId", "timestamp", "attempt"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["exec:begin", "exec:chunk", "exec:end", "exec:retry"]
        },
        "correlationId": { "type": "string", "minLength": 1 },
        "timestamp": { "type": "string", "minLength": 1 },
        "attempt": { "type": "integer", "minimum": 1 },
        "command": { "type": ["string", "null"] },
        "args": { "type": ["array", "null"], "items": { "type": "string" } },
        "cwd": { "type": ["string", "null"] },
        "sessionId": { "type": ["string", "null"] },
        "sandboxState": { "type": ["string", "null"] },
        "stream": { "type": ["string", "null"] },
        "sequence": { "type": ["integer", "null"] },
        "bytes": { "type": ["integer", "null"] },
        "data": { "type": ["string", "null"] },
        "exitCode": { "type": ["integer", "null"] },
        "signal": { "type": ["string", "null"] },
        "durationMs": { "type": ["integer", "null"] },
        "stdout": { "type": ["string", "null"] },
        "stderr": { "type": ["string", "null"] },
        "delayMs": { "type": ["integer", "null"] },
        "errorMessage": { "type": ["string", "null"] }
      },
      "additionalProperties": true
    },
    "collabToolCall": {
      "type": "object",
      "required": [
        "observed_at",
        "stage_id",
        "command_index",
        "event_type",
        "item_id",
        "tool",
        "status",
        "sender_thread_id",
        "receiver_thread_ids"
      ],
      "additionalProperties": false,
      "properties": {
        "observed_at": { "type": "string", "minLength": 1 },
        "stage_id": { "type": "string", "minLength": 1 },
        "command_index": { "type": "integer", "minimum": 1 },
        "event_type": { "type": "string", "enum": ["item.started", "item.completed", "item.updated"] },
        "item_id": { "type": "string", "minLength": 1 },
        "tool": { "type": "string", "minLength": 1 },
        "status": { "type": "string", "enum": ["in_progress", "completed", "failed"] },
        "sender_thread_id": { "type": "string", "minLength": 1 },
        "receiver_thread_ids": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 }
        },
        "prompt": { "type": ["string", "null"] },
        "agents_states": {
          "type": ["object", "null"],
          "additionalProperties": true
        }
      }
    },
    "designArtifact": {
      "type": "object",
      "required": ["stage", "status", "relative_path"],
      "additionalProperties": false,
      "properties": {
        "stage": {
          "type": "string",
          "enum": [
            "extract",
            "reference",
            "components",
            "motion",
            "video",
            "visual-regression",
            "style-ingestion",
            "design-brief",
            "aesthetic-plan",
            "implementation",
            "guardrail",
            "design-history"
          ]
        },
        "status": { "type": "string", "enum": ["succeeded", "skipped", "failed"] },
        "relative_path": { "type": "string", "minLength": 1 },
        "type": { "type": ["string", "null"] },
        "description": { "type": ["string", "null"] },
        "approvals": {
          "type": "array",
          "items": { "$ref": "#/definitions/designArtifactApproval" }
        },
        "quota": { "$ref": "#/definitions/designArtifactQuota" },
        "expiry": { "$ref": "#/definitions/designArtifactExpiry" },
        "privacy_notes": { "type": "array", "items": { "type": "string" } },
        "config_hash": { "type": ["string", "null"] },
        "metadata": { "type": ["object", "null"] }
      }
    },
    "designArtifactApproval": {
      "type": "object",
      "required": ["id", "actor", "timestamp"],
      "additionalProperties": false,
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "actor": { "type": "string", "minLength": 1 },
        "reason": { "type": ["string", "null"] },
        "timestamp": { "type": "string", "minLength": 1 }
      }
    },
    "designArtifactQuota": {
      "type": "object",
      "required": ["type", "limit", "unit"],
      "additionalProperties": false,
      "properties": {
        "type": { "type": "string", "enum": ["storage", "runtime"] },
        "limit": { "type": "number", "minimum": 0 },
        "unit": { "type": "string", "enum": ["MB", "seconds"] },
        "consumed": { "type": ["number", "null"], "minimum": 0 }
      }
    },
    "designArtifactExpiry": {
      "type": "object",
      "required": ["date", "policy"],
      "additionalProperties": false,
      "properties": {
        "date": { "type": "string", "minLength": 1 },
        "policy": { "type": "string", "minLength": 1 }
      }
    },
    "designArtifactsSummary": {
      "type": "object",
      "required": ["total_artifacts", "generated_at", "stages"],
      "additionalProperties": false,
      "properties": {
        "total_artifacts": { "type": "integer", "minimum": 0 },
        "generated_at": { "type": "string", "minLength": 1 },
        "storage_bytes": { "type": ["integer", "null"], "minimum": 0 },
        "stages": {
          "type": "array",
          "items": { "$ref": "#/definitions/designArtifactsSummaryStage" }
        },
        "errors": { "type": "array", "items": { "type": "string" } }
      }
    },
    "designArtifactsSummaryStage": {
      "type": "object",
      "required": ["stage", "succeeded", "failed", "skipped"],
      "additionalProperties": false,
      "properties": {
        "stage": {
          "type": "string",
          "enum": [
            "extract",
            "reference",
            "components",
            "motion",
            "video",
            "visual-regression",
            "style-ingestion",
            "design-brief",
            "aesthetic-plan",
            "implementation",
            "guardrail",
            "design-history"
          ]
        },
        "succeeded": { "type": "integer", "minimum": 0 },
        "failed": { "type": "integer", "minimum": 0 },
        "skipped": { "type": "integer", "minimum": 0 },
        "artifacts": { "type": ["integer", "null"], "minimum": 0 },
        "notes": { "type": "array", "items": { "type": "string" } }
      }
    },
    "designToolkitArtifact": {
      "type": "object",
      "required": ["id", "stage", "status", "relative_path"],
      "additionalProperties": false,
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "stage": {
          "type": "string",
          "enum": ["extract", "tokens", "styleguide", "reference", "self-correct", "publish"]
        },
        "status": { "type": "string", "enum": ["succeeded", "skipped", "failed"] },
        "relative_path": { "type": "string", "minLength": 1 },
        "description": { "type": ["string", "null"] },
        "approvals": {
          "type": "array",
          "items": { "$ref": "#/definitions/designArtifactApproval" }
        },
        "retention": {
          "type": "object",
          "required": ["days", "autoPurge", "expiry"],
          "additionalProperties": false,
          "properties": {
            "days": { "type": "integer", "minimum": 1 },
            "autoPurge": { "type": "boolean" },
            "auto_purge": { "type": "boolean" },
            "expiry": { "type": "string", "minLength": 1 },
            "policy": { "type": ["string", "null"] }
          }
        },
        "metrics": { "type": ["object", "null"] },
        "privacy_notes": { "type": "array", "items": { "type": "string" } }
      }
    },
    "designToolkitSummary": {
      "type": "object",
      "required": ["generated_at", "stages"],
      "additionalProperties": false,
      "properties": {
        "generated_at": { "type": "string", "minLength": 1 },
        "stages": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["stage", "artifacts"],
            "additionalProperties": false,
            "properties": {
              "stage": {
                "type": "string",
                "enum": ["extract", "tokens", "styleguide", "reference", "self-correct", "publish"]
              },
              "artifacts": { "type": "integer", "minimum": 0 },
              "metrics": { "type": ["object", "null"] },
              "notes": { "type": "array", "items": { "type": "string" } }
            }
          }
        },
        "totals": { "type": ["object", "null"] },
        "approvals": { "type": ["array", "null"], "items": { "type": "string" } }
      }
    },
    "designPlan": {
      "type": "object",
      "required": ["mode", "brief"],
      "additionalProperties": false,
      "properties": {
        "mode": { "type": "string", "enum": ["fresh", "clone-informed"] },
        "brief": {
          "type": "object",
          "required": ["path"],
          "additionalProperties": false,
          "properties": {
            "path": { "type": "string", "minLength": 1 },
            "hash": { "type": ["string", "null"] },
            "id": { "type": ["string", "null"] }
          }
        },
        "aesthetic_plan": {
          "type": "object",
          "required": ["path"],
          "additionalProperties": false,
          "properties": {
            "path": { "type": "string", "minLength": 1 },
            "snippet_version": { "type": ["string", "null"] },
            "id": { "type": ["string", "null"] }
          }
        },
        "implementation": {
          "type": "object",
          "required": ["path"],
          "additionalProperties": false,
          "properties": {
            "path": { "type": "string", "minLength": 1 },
            "complexity": { "type": ["string", "null"] }
          }
        },
        "reference_style_id": { "type": ["string", "null"] },
        "style_profile_id": { "type": ["string", "null"] },
        "generated_at": { "type": ["string", "null"] }
      }
    },
    "designStyleOverlap": {
      "type": "object",
      "required": ["overall"],
      "additionalProperties": false,
      "properties": {
        "palette": { "type": ["number", "null"], "minimum": 0, "maximum": 1 },
        "typography": { "type": ["number", "null"], "minimum": 0, "maximum": 1 },
        "motion": { "type": ["number", "null"], "minimum": 0, "maximum": 1 },
        "spacing": { "type": ["number", "null"], "minimum": 0, "maximum": 1 },
        "overall": { "type": "number", "minimum": 0, "maximum": 1 },
        "gate": { "type": ["string", "null"], "enum": ["pass", "fail", null] },
        "threshold": { "type": ["number", "null"], "minimum": 0, "maximum": 1 },
        "comparison_window": { "type": ["array", "null"], "items": { "type": "string" } },
        "reference_style_id": { "type": ["string", "null"] }
      }
    },
    "designGuardrail": {
      "type": "object",
      "required": ["report_path", "status"],
      "additionalProperties": false,
      "properties": {
        "report_path": { "type": "string", "minLength": 1 },
        "status": { "type": "string", "enum": ["pass", "fail"] },
        "snippet_version": { "type": ["string", "null"] },
        "strictness": { "type": ["string", "null"], "enum": ["low", "medium", "high", null] },
        "slop_threshold": { "type": ["number", "null"], "minimum": 0, "maximum": 1 },
        "mode": { "type": ["string", "null"], "enum": ["fresh", "clone-informed", null] },
        "scores": { "type": ["object", "null"], "additionalProperties": { "type": "number" } },
        "recommendations": { "type": "array", "items": { "type": "string" } },
        "notes": { "type": "array", "items": { "type": "string" } },
        "style_overlap": { "anyOf": [{ "type": "null" }, { "$ref": "#/definitions/designStyleOverlap" }] }
      }
    },
    "designHistory": {
      "type": "object",
      "required": ["path"],
      "additionalProperties": false,
      "properties": {
        "path": { "type": "string", "minLength": 1 },
        "mirror_path": { "type": ["string", "null"] },
        "entries": { "type": ["integer", "null"], "minimum": 0 },
        "max_entries": { "type": ["integer", "null"], "minimum": 1 },
        "updated_at": { "type": ["string", "null"] },
        "mode": { "type": ["string", "null"], "enum": ["fresh", "clone-informed", null] }
      }
    },
    "designStyleProfile": {
      "type": "object",
      "required": ["id", "relative_path"],
      "additionalProperties": false,
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "relative_path": { "type": "string", "minLength": 1 },
        "source_url": { "type": ["string", "null"] },
        "ingestion_run": { "type": ["string", "null"] },
        "similarity_level": { "type": ["string", "null"], "enum": ["low", "medium", "high", null] },
        "do_not_copy": {
          "type": ["object", "null"],
          "additionalProperties": false,
          "properties": {
            "logos": { "type": "array", "items": { "type": "string" } },
            "wordmarks": { "type": "array", "items": { "type": "string" } },
            "unique_shapes": { "type": "array", "items": { "type": "string" } },
            "unique_illustrations": { "type": "array", "items": { "type": "string" } },
            "other": { "type": "array", "items": { "type": "string" } }
          }
        },
        "retention_days": { "type": ["integer", "null"], "minimum": 0 },
        "expiry": { "anyOf": [{ "type": "null" }, { "$ref": "#/definitions/designArtifactExpiry" }] },
        "approvals": {
          "type": "array",
          "items": { "$ref": "#/definitions/designArtifactApproval" }
        },
        "notes": { "type": "array", "items": { "type": "string" } }
      }
    },
    "designMetrics": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "aesthetic_axes_completeness": { "type": ["number", "null"], "minimum": 0, "maximum": 1 },
        "originality_score": { "type": ["number", "null"], "minimum": 0, "maximum": 1 },
        "accessibility_score": { "type": ["number", "null"], "minimum": 0, "maximum": 1 },
        "brief_alignment_score": { "type": ["number", "null"], "minimum": 0, "maximum": 1 },
        "slop_risk": { "type": ["number", "null"], "minimum": 0, "maximum": 1 },
        "diversity_penalty": { "type": ["number", "null"], "minimum": 0, "maximum": 1 },
        "similarity_to_reference": { "type": ["number", "null"], "minimum": 0, "maximum": 1 },
        "style_overlap": { "type": ["number", "null"], "minimum": 0, "maximum": 1 },
        "style_overlap_gate": { "type": ["string", "null"], "enum": ["pass", "fail", null] },
        "snippet_version": { "type": ["string", "null"] }
      }
    }
  }
}
