# Action Plan - Slimdown Audit (Task 0101-slimdown-audit)

## Status Snapshot
- Current Phase: Planning (no-regression plan captured)
- Run Manifest Link: TBD (capture docs-review before implementation)
- Approvals / Escalations: record in `tasks/index.json`

## Evidence Notes
- `metrics.json` is NDJSON (one JSON object per line; parse line-by-line).
- `out/<task-id>/state.json` is generated by metrics aggregation.
- Store manifests under `.runs/<task-id>/cli/<run-id>/manifest.json`.

## Implementation Phases (no regression)
Phase 0 - Baseline invariants + regression tripwires
- Entry: core CI lane green; `.runs/` workflow produces manifests; task discipline in place.
- Work: add characterization tests for execution-mode resolution, task/run ID sanitization, env/path resolution, and pipeline selection edge cases; capture baseline manifests for diagnostics/docs-review/implementation-gate/frontend-testing.
- Exit: characterization tests pass; baseline manifests linked in task docs; no new dependencies.

Phase 1 - Delete clearly-dead wrappers and legacy harnesses
- Entry: Phase 0 exit criteria met; repo/CI/docs scans show no references.
- Work: remove legacy mcp-runner migrate/metrics scripts, obsolete wrappers, and unused harness scripts (only after docs updated).
- Exit: zero references remain; docs updated; core lane green with a post-change manifest.

Phase 2 - Consolidate duplicated helpers
- Entry: Phase 1 merged; tests cover helper-visible behavior.
- Work: unify atomic writes, sanitizers, pathExists, toPosixPath, date parsing, slugify; remove duplicate implementations.
- Exit: one canonical helper per concept; tests assert string parity; net-negative diff.

Phase 3 - Normalize environment/path resolution
- Entry: Phase 2 merged; tests cover external out dirs and path normalization.
- Work: standardize on `CODEX_ORCHESTRATOR_ROOT` and `CODEX_ORCHESTRATOR_PACKAGE_ROOT`; centralize repo/runs/out discovery; ensure `dist/` ships shared helpers.
- Exit: no parallel resolver clones; status UI/run-review/mirror read manifests consistently; core lane green.

Phase 4 - Pipeline/stage-set dedupe (no ID/order changes)
- Entry: Phase 3 merged; pipeline contract list (IDs + stage order) frozen.
- Work: consolidate spec-guard, delegation-guard, and docs-review stage sets; remove legacy pipeline IDs only after reference inventory and replacement path is proven.
- Exit: pipeline IDs and stage order unchanged; manifests/evidence paths unchanged; targeted pipelines run.

Phase 5 - Remove shims/index indirection
- Entry: Phase 4 merged; import graph stable with tests.
- Work: remove optional-deps wrappers, persistence shims, and control-plane/scheduler index re-exports; update imports to concrete modules.
- Exit: shims deleted; behavior identical; core lane green with any required matrix runs.

Phase 6 - Final guardrail pass + documentation update
- Entry: Phases 0-5 merged or staged.
- Work: run full guardrail chain; update checklists/mirrors with manifest paths.
- Exit: evidence manifests captured; diff budget adhered to (or explicit override recorded); docs reflect actual usage.

## Candidate Audit Areas (safe deletions/consolidations)
- Legacy scripts and wrappers: old mcp-runner migrate/metrics, codex-devtools wrapper, unused parallel-goals harness.
- Duplicate helpers: atomic JSON writes, task/run ID sanitizers, pathExists, toPosixPath, date parsing.
- Env/path resolution sprawl: multiple repo/runs/out resolvers across scripts and orchestrator.
- Pipeline duplication: repeated spec-guard/delegation-guard/docs-review blocks; devtools pipeline variants.
- Shim/index modules: optional-deps wrappers, control-plane/scheduler index re-exports.

## Risk / Mitigation Checklist
- Removing "unused" code that is still referenced in docs/SOPs.
  - Mitigation: repo + docs + CI scans; update docs in the same PR; verify manifests post-change.
- Changing user-facing strings or CLI output.
  - Mitigation: characterization tests with exact string assertions; no wording changes.
- Path resolution regressions (external out dir, OS-specific paths).
  - Mitigation: normalization tests; run status UI and mirror tooling canaries.
- Dist/package parity issues for shared helpers.
  - Mitigation: confirm `dist/` includes shared helpers; run packaged resolution tests.
- Stage-set refactor changes pipeline behavior.
  - Mitigation: treat pipeline IDs + stage order + command lines as immutable; compare manifests.
- Optional dependency load behavior changes.
  - Mitigation: preserve lazy-load semantics and error guidance.

## Test and Verification Plan
Always run (each phase PR):
- `npm run build`
- `npm run lint`
- `npm run test`
- spec-guard (packaged or script)
- `npm run docs:check`
- `npm run docs:freshness`

Golden pipeline verification (attach manifests):
- `codex-orchestrator start diagnostics`
- `codex-orchestrator start docs-review`
- `codex-orchestrator start implementation-gate`
- `codex-orchestrator start frontend-testing` (with DevTools when applicable)

Reference integrity checks:
- `rg` for removed file names, pipeline IDs, and env var names
- verify `package.json`, `codex.orchestrator.json`, and docs/SOPs have no dead references

## Do-Not-Do List (no regressions)
- Do not change public APIs, CLI flags, defaults, or user-facing strings.
- Do not change pipeline IDs or stage order for public pipelines.
- Do not change manifest schema or evidence path conventions.
- Do not add dependencies.
- Do not mix refactors with broad formatting-only changes.
- Do not remove legacy entrypoints without evidence they are unused.
- Do not change optional dependency behavior.

## Next Review
- Date: TBD
- Agenda: confirm tripwire tests + manifest evidence before moving beyond Phase 0.
