# Action Plan - Slimdown Audit (Task 0101-slimdown-audit)

## Status Snapshot
- [x] Phase 6 - final guardrail pass complete
  - [x] docs-review `.runs/0101-slimdown-audit/cli/2026-01-03T19-18-50-704Z-783d9ad9/manifest.json`
  - [x] implementation-gate `.runs/0101-slimdown-audit/cli/2026-01-03T18-59-01-699Z-c2f0e210/manifest.json`
  - [x] subagent diagnostics `.runs/0101-slimdown-audit-phase3scan/cli/2026-01-03T17-56-17-000Z-8a2830d3/manifest.json`
- Approvals / Escalations: record in `tasks/index.json`

## Evidence Notes
- `metrics.json` is NDJSON (one JSON object per line; parse line-by-line).
- `out/<task-id>/state.json` is generated by metrics aggregation.
- Store manifests under `.runs/<task-id>/cli/<run-id>/manifest.json`.

## Implementation Phases (no regression)
Phase 0 - Baseline invariants + regression tripwires
- Entry: core CI lane green; `.runs/` workflow produces manifests; task discipline in place.
- Work: add characterization tests for execution-mode resolution, task/run ID sanitization, env/path resolution, and pipeline selection edge cases; capture baseline manifests for diagnostics/docs-review/implementation-gate/frontend-testing.
- Exit: characterization tests pass; baseline manifests linked in task docs; no new dependencies.

Phase 1 - Delete clearly dead wrappers and legacy harnesses
- Entry: Phase 0 exit criteria met; repo/CI/docs scans show no references.
- Work: remove legacy mcp-runner migrate/metrics scripts, obsolete wrappers, and unused harness scripts (only after docs updated).
- Exit: ensure zero references to it remain; docs updated; core lane green with a post-change manifest.

Phase 2 - Consolidate duplicated helpers
- Entry: Phase 1 merged; tests cover helper-visible behavior.
- Work: unify atomic writes, sanitizers, pathExists, toPosixPath, date parsing, slugify; remove duplicate implementations.
- Exit: one canonical helper per concept; tests assert string parity; net-negative diff.

Phase 3 - Normalize environment/path resolution
- Entry: Phase 2 merged; tests cover external out dirs and path normalization.
- Work: standardize on `CODEX_ORCHESTRATOR_ROOT` and `CODEX_ORCHESTRATOR_PACKAGE_ROOT`; centralize repo/runs/out discovery; ensure `dist/` ships shared helpers.
- Exit: no parallel resolver clones; status UI/run-review/mirror read manifests consistently; core lane green.

Phase 4 - Pipeline/stage-set dedupe (no ID/order changes)
- Entry: Phase 3 merged; pipeline contract list (IDs + stage order) frozen.
- Work: consolidate spec-guard, delegation-guard, and docs-review stage sets; remove legacy pipeline IDs only after reference inventory and replacement path is proven.
- Exit: pipeline IDs and stage order unchanged; manifests/evidence paths unchanged; targeted pipelines run.

Phase 5 - Remove shims/index indirection
- Entry: Phase 4 merged; import graph stable with tests.
- Work: remove optional-deps wrappers, persistence shims, and control-plane/scheduler index re-exports; update imports to concrete modules.
- Exit: shims deleted; behavior identical; core lane green with any required matrix runs.

Phase 6 - Final guardrail pass + documentation update
- Entry: Phases 0-5 merged or staged.
- Work: run full guardrail chain; update checklists/mirrors with manifest paths.
- Exit: evidence manifests captured; diff budget adhered to (or explicit override recorded); docs reflect actual usage.

## Extended Phases (7–20) — Legacy Runbook Alignment
Phases 7–20 are already defined in the runbooks under `tasks/tasks-0101-slimdown-audit.md`. This section keeps numbering consistent with the task checklist. Entry/exit for each phase is the corresponding runbook plus a full guardrail pass with manifest evidence.

Phase 7 - Guardrail stage-set reuse (delegation/spec-guard stage sets).
Phase 8 - Docs-review stage-set reuse, static server reuse, fallback diagnostics, resolver alignment.
Phase 9 - Resolver unification and dist shipping parity.
Phase 10 - Script helper drift cleanup (date math, toPosixPath, run-manifests reuse).
Phase 11 - Status UI task-key normalization.
Phase 12 - Docs + run/out resolver alignment (run-review, mirror, docs outputs).
Phase 13 - Env resolver call-site consolidation.
Phase 14 - Docs helper pathExists reuse.
Phase 15 - Resolver API trim.
Phase 16 - Script-side pathExists reuse.
Phase 17 - CLI environment resolver wrapper removal.
Phase 18 - Guardrail detection normalization + optional-deps wrapper removal.
Phase 19 - Persistence/JSONL shim cleanup + identifier guard inline.
Phase 20 - Guardrail detection normalization + control-plane/scheduler shim cleanup.

## Candidate Audit Areas (safe deletions/consolidations)
- Legacy scripts and wrappers: old mcp-runner migrate/metrics, codex-devtools wrapper, unused parallel-goals harness.
- Duplicate helpers: atomic JSON writes, task/run ID sanitizers, pathExists, toPosixPath, date parsing.
- Env/path resolution sprawl: multiple repo/runs/out resolvers across scripts and orchestrator.
- Pipeline duplication: repeated spec-guard/delegation-guard/docs-review blocks; devtools pipeline variants.
- Shim/index modules: optional-deps wrappers, control-plane/scheduler index re-exports.

## Risk / Mitigation Checklist
- Removing "unused" code that is still referenced in docs/SOPs.
  - Mitigation: repo + docs + CI scans; update docs in the same PR; verify manifests post-change.
- Changing user-facing strings or CLI output.
  - Mitigation: characterization tests with exact string assertions; no wording changes.
- Path resolution regressions (external out dir, OS-specific paths).
  - Mitigation: normalization tests; run status UI and mirror tooling canaries.
- Dist/package parity issues for shared helpers.
  - Mitigation: confirm `dist/` includes shared helpers; run packaged resolution tests.
- Stage-set refactor changes pipeline behavior.
  - Mitigation: treat pipeline IDs + stage order + command lines as immutable; compare manifests.
- Optional dependency load behavior changes.
  - Mitigation: preserve lazy-load semantics and error guidance.

## Test and Verification Plan
Always run (each phase PR):
- `npm run build`
- `npm run lint`
- `npm run test`
- spec-guard (packaged or script)
- `npm run docs:check`
- `npm run docs:freshness`

Golden pipeline verification (attach manifests):
- `codex-orchestrator start diagnostics`
- `codex-orchestrator start docs-review`
- `codex-orchestrator start implementation-gate`
- `codex-orchestrator start frontend-testing` (with DevTools when applicable)

Reference integrity checks:
- `rg` for removed file names, pipeline IDs, and env var names
- verify `package.json`, `codex.orchestrator.json`, and docs/SOPs have no dead references

## Do-Not-Do List (no regressions)
- Public APIs, CLI flags, defaults, and user-facing strings must not change.
- Pipeline IDs and stage order for public pipelines must remain stable.
- Manifest schema and evidence path conventions must not change.
- New dependencies must not be added.
- Refactors and formatting-only changes must not be mixed.
- Legacy entrypoints must not be removed without evidence of disuse.
- Optional dependency behavior must not change.

## Next Review
- Date: TBD
- Agenda: confirm tripwire tests + manifest evidence before moving beyond Phase 0.
