# Action Plan - Codex Delegation Autonomy Platform (Task 0940)

## Status Snapshot
- Current Phase: Planning
- Run Manifest Link: `.runs/0940-delegation-autonomy-platform/cli/2026-01-07T00-11-49-275Z-65784bb1/manifest.json`
- Metrics / State Snapshots: `.runs/0940-delegation-autonomy-platform/metrics.json`, `out/0940-delegation-autonomy-platform/state.json`
- Approvals / Escalations: record in tasks/index.json

## Evidence Notes
- metrics.json is NDJSON (one JSON object per line; parse line-by-line).
- out/0940-delegation-autonomy-platform/state.json is generated by metrics aggregation.

## Milestones & Tasks
1. Planning + collateral
   - Draft PRD, TECH_SPEC, ACTION_PLAN, mini-spec, and task checklist.
   - Update tasks/index.json, docs/PRD.md, docs/TECH_SPEC.md, docs/ACTION_PLAN.md, docs/TASKS.md, docs/docs-freshness-registry.json, .agent/task mirror.
   - Spec clarifications captured; validate implementation matches:
     - Enablement model: delegate tools enabled only via mcp_servers.delegation.enabled=true per run.
     - Policy-change events: rlm_policy_changed with payload { old_policy, new_policy, effective_at }.
   - Capture docs-review manifest.
2. Delegation MCP server
   - Implement delegate.* tool surface in the npm package.
   - Spawn delegate runs via codex -c with minimal MCP config.
   - Add pause/cancel semantics (checkpoint stop at step boundary).
   - Require confirm_nonce for delegate.cancel; return confirmation_required when missing.
3. RLM policy + delegation-first behavior
   - Make RLM always-on for delegated runs.
   - Define RLM runtime mechanics (externalized context, REPL, recursive sub-calls) and sandbox defaults.
   - Enforce sandbox isolation: artifacts/scratch RW only; events/manifest/control never mounted; repo access via context APIs.
   - Add RLM budgets (max_iterations, max_subcalls, wall_clock_timeout_ms) and document budget-exceeded behavior.
   - Ship delegation-first skill guidance for top-level Codex.
   - Add question queue for escalations to the parent run.
4. Event stream + run control
   - Emit events.jsonl per run and update manifest summaries.
   - Emit RLM trajectory events (repl_exec, subcall_started/completed, budget_exceeded) with artifact references.
   - Emit RLM context inspection events (context_search/peek/chunk_read) via REPL helpers.
   - Define control.json request schema + runner polling behavior for pause/resume/cancel.
   - Add control endpoints for pause/resume/cancel.
5. UI + TUI
   - Extend status UI into a control center with live events.
   - Add TUI for quick monitoring and controls.
   - Add settings pages for global + repo flags.
6. GitHub workflows
   - Integrate gh/API-based GitHub actions behind repo flags.
   - Enforce per-operation allowlist from repo config only (no global grant); add deny-by-default tests.
   - Define canonical GitHub operation IDs in TECH_SPEC; add tests that reject unknown IDs.
   - Add confirm-to-act tests for merge: without confirmation -> confirmation_required; with confirmation -> executes (events emitted).
   - Surface PR status/checks and merge controls in UI.
7. Validation + handoff
   - Run implementation-gate with required guardrails.
   - Update checklist mirrors with manifest evidence.

## Risks & Mitigations
- Scope sprawl across UI, MCP tools, and GitHub integration.
  - Mitigation: stage rollout by milestone; keep tool surface minimal.
- Overreliance on global config leading to unsafe defaults.
  - Mitigation: disable tools by default and require explicit enable per run.
- Pause/cancel semantics disrupting pipelines.
  - Mitigation: checkpoint stop at step boundary with explicit resume flow.
- Control-plane security risk (local HTTP endpoints abused without auth/CSRF).
  - Mitigation: bind to 127.0.0.1, require auth token, add CSRF protections, confirm prompts for destructive actions.
- events.jsonl corruption or ordering drift under concurrent writers.
  - Mitigation: single-writer append-only model with monotonic seq and schema versioning.
- RLM policy changes mid-run creating unclear expectations.
  - Mitigation: specify policy change timing (new runs or resume boundary only).
- RLM runaway iterations or sandbox escape.
  - Mitigation: enforce RLM budgets, default to isolated Docker sandbox, and add trace/budget tests.

## Next Review
- Date: 2026-01-20
- Agenda: confirm collateral approval, validate MCP tool surface design, and align UI scope with status UI baseline.
