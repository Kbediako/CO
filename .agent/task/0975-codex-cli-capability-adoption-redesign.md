# Task Checklist - Codex CLI Capability Adoption + Low-Friction Downstream Reliability (0975)

- MCP Task ID: `0975-codex-cli-capability-adoption-redesign`
- Primary PRD: `docs/PRD-codex-cli-capability-adoption-redesign.md`
- TECH_SPEC: `tasks/specs/0975-codex-cli-capability-adoption-redesign.md`
- ACTION_PLAN: `docs/ACTION_PLAN-codex-cli-capability-adoption-redesign.md`
- Summary of scope: minimal additive redesign to improve practical Codex CLI capability adoption and downstream onboarding reliability.

> Set `MCP_RUNNER_TASK_ID=0975-codex-cli-capability-adoption-redesign` for orchestrator commands. Guardrails required: `node scripts/delegation-guard.mjs`, `node scripts/spec-guard.mjs --dry-run`, `npm run build`, `npm run lint`, `npm run test`, `npm run docs:check`, `npm run docs:freshness`, `node scripts/diff-budget.mjs`, `npm run review`. Mirror with `.agent/task/0975-codex-cli-capability-adoption-redesign.md`.

## Checklist

### Foundation
- [x] Task scaffolding + mirrors registered. - Evidence: `tasks/tasks-0975-codex-cli-capability-adoption-redesign.md`, `.agent/task/0975-codex-cli-capability-adoption-redesign.md`, `tasks/index.json`.
- [x] PRD + TECH_SPEC + ACTION_PLAN drafted. - Evidence: `docs/PRD-codex-cli-capability-adoption-redesign.md`, `tasks/specs/0975-codex-cli-capability-adoption-redesign.md`, `docs/ACTION_PLAN-codex-cli-capability-adoption-redesign.md`, `docs/TECH_SPEC-codex-cli-capability-adoption-redesign.md`.
- [x] Delegated baseline + downstream smoke evidence captured. - Evidence: collab subagent streams `019c745a-a368-7d83-bd1c-76543479c209`, `019c745a-a87f-7ea1-a7ed-9842ccb57cfe`.
- [x] Docs-review manifest captured (pre-implementation). - Evidence: `.runs/0975-codex-cli-capability-adoption-redesign/cli/2026-02-19T05-40-07-222Z-efbb9b74/manifest.json`.
- [x] Delegation guard subagent-manifest stream captured (`<task-id>-<stream>`). - Evidence: `.runs/0975-codex-cli-capability-adoption-redesign-scout/cli/2026-02-19T05-36-06-693Z-7267ee91/manifest.json`.
- [x] Standalone pre-implementation review approval captured. - Evidence: `out/0975-codex-cli-capability-adoption-redesign/manual/pre-implementation-standalone-review.log`.

### Implementation
- [x] Package includes fallback pipeline config for downstream npm usage. - Evidence: `package.json`, `scripts/pack-audit.mjs`, `orchestrator/src/cli/config/userConfig.ts`.
- [x] `init codex` ships downstream `codex.orchestrator.json` template. - Evidence: `orchestrator/src/cli/init.ts`, `orchestrator/tests/InitTemplates.test.ts`, `out/0975-codex-cli-capability-adoption-redesign/manual/downstream-smoke-2026-02-19.md`.
- [x] Help behavior fixed for `init` and `plan`. - Evidence: `bin/codex-orchestrator.ts`, `tests/cli-command-surface.spec.ts`.
- [x] `delegation setup --repo` preserves repo pin in plan/apply command invocation. - Evidence: `orchestrator/src/cli/delegationSetup.ts`, `tests/cli-command-surface.spec.ts`, `out/0975-codex-cli-capability-adoption-redesign/manual/downstream-smoke-2026-02-19.md`.
- [x] Docs/guidance aligned with new behavior and capability adoption defaults. - Evidence: `README.md`, `docs/README.md`.

### Validation and handoff
- [x] Manual downstream smoke re-run confirms improved onboarding behavior. - Evidence: `out/0975-codex-cli-capability-adoption-redesign/manual/downstream-smoke-2026-02-19.md`.
- [x] Required check sequence completed successfully. - Evidence: `out/0975-codex-cli-capability-adoption-redesign/manual/required-checks-2026-02-19.log`, `out/0975-codex-cli-capability-adoption-redesign/manual/required-checks-2026-02-19-review-mitigation-final.log`, `.runs/0975-codex-cli-capability-adoption-redesign/cli/2026-02-19T05-40-07-222Z-efbb9b74/review/prompt.txt`.
- [x] Post-implementation standalone review + elegance pass completed. - Evidence: `out/0975-codex-cli-capability-adoption-redesign/manual/post-implementation-review-elegance-2026-02-19.md`, `out/0975-codex-cli-capability-adoption-redesign/manual/post-implementation-review-elegance-2026-02-19-review-mitigation.md`.

### Follow-up Intake (Tower-Defence + Deliberation)
- [x] Import external issue log into 0975 evidence and triage list. - Evidence: `/Users/kbediako/Code/tower-defence/docs/codex-orchestrator-issues.md`, `out/0975-codex-cli-capability-adoption-redesign/manual/tower-defence-issues-intake-2026-02-19.md`.
- [x] Re-intake tower-defence issue log via delegated scan (no direct cross-repo manual digging) and confirm net-new IDs. - Evidence: `out/0975-codex-cli-capability-adoption-redesign/manual/tower-defence-issues-intake-2026-02-20.md`.
- [x] CO-001: `start --help` must render help without run setup side effects. - Evidence: `bin/codex-orchestrator.ts`, `tests/cli-command-surface.spec.ts`.
- [x] CO-002: Align doctor cloud preflight env-id resolution with runtime pipeline/stage metadata resolution. - Evidence: `orchestrator/src/cli/doctor.ts`, `orchestrator/tests/Doctor.test.ts`, `out/0975-codex-cli-capability-adoption-redesign/manual/tower-defence-followup-implementation-2026-02-19.md`.
- [x] CO-003: Populate `cloud_execution` metadata early for in-progress cloud runs (job id + log/status links). - Evidence: `orchestrator/src/cloud/CodexCloudTaskExecutor.ts`, `orchestrator/src/cli/orchestrator.ts`, `orchestrator/tests/CodexCloudTaskExecutor.test.ts`, `orchestrator/tests/OrchestratorCloudAutoScout.test.ts`, `out/0975-codex-cli-capability-adoption-redesign/manual/downstream-smoke-cloud-progress-2026-02-19.md`.
- [x] CO-004: Clarify resolver logging to distinguish repo file load vs defaults/fallback. - Evidence: `orchestrator/src/cli/services/pipelineResolver.ts`, `orchestrator/tests/PipelineResolverEnvOverrides.test.ts`, `out/0975-codex-cli-capability-adoption-redesign/manual/tower-defence-followup-implementation-2026-02-19.md`.
- [x] CO-005: Standalone review startup-loop issue addressed in CO via wrapper mitigation (fail-fast + issue logging); residual upstream risk remains for direct `codex review`. - Evidence: `out/0975-codex-cli-capability-adoption-redesign/manual/standalone-review-hang-repro-2026-02-19.md`, `out/0975-codex-cli-capability-adoption-redesign/manual/standalone-review-wrapper-mitigation-2026-02-19.md`, `scripts/run-review.ts`, `tests/run-review.spec.ts`.
- [x] CO-005 mitigation: standalone review wrapper detects delegation startup loops and fails fast with actionable diagnostics. - Evidence: `scripts/run-review.ts`, `tests/run-review.spec.ts`, `out/0975-codex-cli-capability-adoption-redesign/manual/standalone-review-wrapper-mitigation-2026-02-19.md`.
- [x] CO-005 mitigation: standalone review wrapper supports automatic issue-bundle capture on failure when enabled. - Evidence: `scripts/run-review.ts`, `tests/run-review.spec.ts`, `out/0975-codex-cli-capability-adoption-redesign/manual/standalone-review-wrapper-mitigation-2026-02-19.md`.
- [x] RR-0101: `npm run review` manifest selection defaults to active task env when `--task` is omitted. - Evidence: `scripts/run-review.ts`, `tests/run-review.spec.ts`, `out/0975-codex-cli-capability-adoption-redesign/manual/standalone-review-wrapper-mitigation-2026-02-19.md`.
- [x] CO-005 runtime policy: validate direct long-run `codex review` reproduction and capture evidence snapshot. - Evidence: `out/0975-codex-cli-capability-adoption-redesign/manual/standalone-review-long-run-repro-2026-02-20.md`, `out/0975-codex-cli-capability-adoption-redesign/manual/standalone-review-long-run-repro-2026-02-20-recheck.json`.
- [x] CO-005 runtime policy (superseded): wrapper reviews were temporarily set to delegation-MCP-off-by-default during startup-loop triage; later replaced with delegation-default-on plus scope-based mitigation. - Evidence: `scripts/run-review.ts`, `tests/run-review.spec.ts`, `docs/standalone-review-guide.md`, `docs/README.md`, `AGENTS.md`, `out/0975-codex-cli-capability-adoption-redesign/manual/standalone-review-runtime-policy-smoke-2026-02-20.md`, `out/0975-codex-cli-capability-adoption-redesign/manual/standalone-review-rootcause-co-repro-2026-02-20.md`.
- [x] CO-005 runtime policy: make wrapper review runtime unbounded by default (timeout guards opt-in). - Evidence: `scripts/run-review.ts`, `tests/run-review.spec.ts`, `docs/standalone-review-guide.md`, `docs/README.md`, `out/0975-codex-cli-capability-adoption-redesign/manual/standalone-review-runtime-policy-smoke-2026-02-20.md`.
- [x] Deliberated directive: move to bootstrap-first config usage (explicit `init/setup`), with package fallback treated as compatibility path only. - Evidence: `orchestrator/src/cli/services/pipelineResolver.ts`, `orchestrator/src/cli/orchestrator.ts`, `tests/cli-command-surface.spec.ts`.
- [x] Add direct test for delegation setup TOML fallback repo re-pin path. - Evidence: `tests/cli-command-surface.spec.ts` (`delegation setup --yes reconfigures unpinned fallback entries when mcp get is unavailable`).
- [x] Centralize CLI argument quoting helper usage across command-preview surfaces. - Evidence: `orchestrator/src/cli/utils/commandPreview.ts`, `orchestrator/src/cli/delegationSetup.ts`, `orchestrator/src/cli/utils/devtools.ts`, `bin/codex-orchestrator.ts`, `orchestrator/tests/CommandPreview.test.ts`.

### Post-Approval Mandates (No-Fallback Preference + Dogfood Loop)
- [x] Fallback visibility: emit explicit structured/operator-visible signals whenever config or cloud fallback paths are used. - Evidence: `orchestrator/src/cli/doctor.ts`, `orchestrator/src/cli/services/pipelineResolver.ts`, `orchestrator/src/cli/orchestrator.ts`, `tests/cli-command-surface.spec.ts`.
- [x] Downstream issue logging: add `doctor --issue-log` workflow to generate reproducible issue bundles for cross-repo/device dogfooding. - Evidence: `orchestrator/src/cli/doctorIssueLog.ts`, `bin/codex-orchestrator.ts`, `tests/cli-command-surface.spec.ts`, `docs/codex-orchestrator-issues.md`.
- [x] Scenario-based testing mandate: add fixture-driven user-flow tests for setup/execution/failure reproduction in dummy repos. - Evidence: `tests/cli-command-surface.spec.ts` (`writes doctor issue logs...`, `warns when plan uses packaged fallback config`).
- [x] Observability contract mandate: add tests asserting agent-critical status/manifest fields remain populated and stable. - Evidence: `orchestrator/tests/CodexCloudTaskExecutor.test.ts`, `orchestrator/tests/OrchestratorCloudAutoScout.test.ts`, `tests/cli-command-surface.spec.ts`.
- [x] Elegance follow-up: doctor preflight now fails closed on invalid stage-set refs instead of silently selecting later stages. - Evidence: `orchestrator/src/cli/doctor.ts`, `orchestrator/tests/Doctor.test.ts`.
- [x] Elegance follow-up: delegation setup now re-pins fallback-detected unpinned entries when `mcp get delegation` is unavailable. - Evidence: `orchestrator/src/cli/delegationSetup.ts`, `tests/cli-command-surface.spec.ts`.
- [x] Standalone-review remediation: nested-cwd `doctor --issue-log` now resolves repo-level runs/out/docs roots. - Evidence: `orchestrator/src/cli/doctorIssueLog.ts`, `orchestrator/tests/_reproIssueLogTask.test.ts`, `out/0975-codex-cli-capability-adoption-redesign/manual/downstream-nested-issue-log-smoke-2026-02-19.md`.
- [x] Manual reproduction discipline: for each new feature/fix in this slice, capture at least one dummy-repo reproduction path in `out/0975.../manual/`. - Evidence: `out/0975-codex-cli-capability-adoption-redesign/manual/downstream-scenario-issue-log-2026-02-19.md`, `out/0975-codex-cli-capability-adoption-redesign/manual/downstream-nested-issue-log-smoke-2026-02-19.md`.

### Approved Next Actions (2026-02-19 Follow-Through)
- [x] Add opt-in automatic failure issue logging for `start`/`flow` (`--auto-issue-log` and env equivalent) with structured output evidence. - Evidence: `bin/codex-orchestrator.ts`, `tests/cli-command-surface.spec.ts`.
- [x] Add strict no-fallback repo-config mode for fail-fast lanes (deny packaged/default fallback when enabled). - Evidence: `orchestrator/src/cli/config/repoConfigPolicy.ts`, `orchestrator/src/cli/config/userConfig.ts`, `orchestrator/src/cli/services/pipelineResolver.ts`, `orchestrator/src/cli/orchestrator.ts`, `bin/codex-orchestrator.ts`, `orchestrator/tests/PipelineResolverEnvOverrides.test.ts`, `tests/cli-command-surface.spec.ts`.
- [x] Centralize command-preview shell quoting helper usage across setup command surfaces. - Evidence: `orchestrator/src/cli/utils/commandPreview.ts`, `orchestrator/src/cli/delegationSetup.ts`, `orchestrator/src/cli/utils/devtools.ts`, `bin/codex-orchestrator.ts`, `orchestrator/tests/CommandPreview.test.ts`, `tests/cli-command-surface.spec.ts`.
- [x] Add scenario-style regression tests covering auto issue logging + strict no-fallback behavior in dummy repos. - Evidence: `tests/cli-command-surface.spec.ts`, `orchestrator/tests/PipelineResolverEnvOverrides.test.ts`, `orchestrator/tests/CommandPreview.test.ts`.
- [x] Capture manual nested-cwd failure reproduction with auto issue logging enabled. - Evidence: `out/0975-codex-cli-capability-adoption-redesign/manual/downstream-scenario-auto-issue-log-strict-2026-02-19.md`.
- [x] Final validation: add patience-first monitoring checkpoints for long-running wrapper reviews and reproduce direct `codex review --uncommitted` in a mock repo before residual-risk closeout. - Evidence: `scripts/run-review.ts`, `tests/run-review.spec.ts`, `docs/standalone-review-guide.md`, `docs/README.md`, `out/0975-codex-cli-capability-adoption-redesign/manual/standalone-review-mock-repo-repro-2026-02-20.md`, `out/0975-codex-cli-capability-adoption-redesign/manual/standalone-review-mock-repo-repro-2026-02-20.json`, `out/0975-codex-cli-capability-adoption-redesign/manual/standalone-review-co-direct-recheck-2026-02-20.json`, `out/0975-codex-cli-capability-adoption-redesign/manual/standalone-review-monitoring-validation-2026-02-20.md`.
- [x] Root-cause mitigation: detect large uncommitted review scopes and emit explicit wrapper/prompt advisories so CO-scale review passes prioritize high-signal findings without relying solely on delegation-off defaults. - Evidence: `scripts/run-review.ts`, `tests/run-review.spec.ts`, `docs/standalone-review-guide.md`, `docs/README.md`, `AGENTS.md`, `out/0975-codex-cli-capability-adoption-redesign/manual/standalone-review-rootcause-co-repro-2026-02-20.md`, `out/0975-codex-cli-capability-adoption-redesign/manual/standalone-review-rootcause-co-repro-2026-02-20.json`, `out/0975-codex-cli-capability-adoption-redesign/manual/standalone-review-rootcause-mitigation-validation-2026-02-20.md`.
- [x] Capability alignment: keep delegation MCP enabled by default for wrapper reviews and provide explicit disable controls/documentation for troubleshooting (no delegation-off default reliance). - Evidence: `scripts/run-review.ts`, `tests/run-review.spec.ts`, `docs/standalone-review-guide.md`, `docs/README.md`, `AGENTS.md`, `out/0975-codex-cli-capability-adoption-redesign/manual/standalone-review-rootcause-mitigation-validation-2026-02-20.md`, `out/0975-codex-cli-capability-adoption-redesign/manual/standalone-review-delegation-default-alignment-2026-02-20.md`.
