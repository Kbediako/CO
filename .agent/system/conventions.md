# Conventions

This repo optimizes for agentic, evidence-backed changes. Conventions here are intentionally “ops-y”: they explain how to run work, capture proof, and keep mirrors in sync.

## Stack & workspace
- **Runtime:** Node.js (recommend Node 20 LTS to match CI).
- **Package manager:** `npm` (use `npm ci` for clean installs).
- **Language:** TypeScript/ESM (project `type: "module"`).
- **Build output:** `dist/` (generated by `npm run build`; not committed).

## Canonical guardrails (non-interactive)
- `npm run build`
- `npm run lint` (runs `npm run build:patterns` first via `prelint`)
- `npm run test` (Vitest in `run` mode; non-watch)
- `node scripts/spec-guard.mjs --dry-run` (local pre-review guard)

Avoid interactive/watch commands in automation:
- `npm run test:watch` runs `vitest` in watch mode and will not exit.

## Task + evidence conventions
- **Task id format:** `<id>-<slug>` (example: `0905-agentic-coding-readiness`).
- **Artifacts:** `.runs/<task-id>/cli/<run-id>/manifest.json` is the canonical evidence file (see `.runs/README.md`).
- **Metrics/state mirrors:** `.runs/<task-id>/metrics.json` and `out/<task-id>/{state.json,runs.json}`.
- **Checklist mirrors (must match):**
  - `tasks/tasks-<id>-<slug>.md` (canonical checklist)
  - `docs/TASKS.md` (snapshot mirror)
  - `.agent/task/<id>-<slug>.md` (agent-facing mirror)
- **Index entry:** `tasks/index.json` tracks task metadata and can store a `gate.log` manifest path for reviewers.

When work is “done”, flip `[ ] → [x]` in every mirror and cite the same manifest path.

## How to capture a manifest
Run the diagnostics pipeline under the correct task id:
```bash
export MCP_RUNNER_TASK_ID=<task-id>
npx codex-orchestrator start diagnostics --format json --no-interactive --task <task-id>
```
The CLI prints the `run_id` and the manifest path under `.runs/<task-id>/cli/<run-id>/manifest.json`.

## Codex-first tooling
- Use `codex exec -- <command>` when you need commands to run through Codex CLI primitives (e.g., when scripting agent loops).
- Use `codex review` for review hand-off; this repo wraps it via `npm run review`.

## Non-interactive command rule
Agents do not have an interactive TTY. If a tool prompts, add a non-interactive flag (`--yes/-y/--force`) or script input (e.g., `printf 'y\n' | <cmd>`). If a tool requires a TTY, use `expect` and script the prompt/response pairs.
