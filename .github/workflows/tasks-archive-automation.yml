name: Tasks Archive Automation

on:
  schedule:
    - cron: '15 3 * * *'
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - docs/TASKS.md
      - docs/tasks-archive-policy.json
      - tasks/index.json
      - scripts/tasks-archive.mjs

concurrency:
  group: tasks-archive-automation
  cancel-in-progress: false

jobs:
  archive:
    uses: ./.github/workflows/archive-automation-base.yml
    permissions:
      contents: write
      pull-requests: write
    with:
      run_command: node scripts/tasks-archive.mjs
      task_id: tasks-archive-automation
      diff_paths: docs/TASKS.md
      archive_branch: task-archives
      archive_out_dir: out/tasks-archive-automation
      archive_glob: TASKS-archive-*.md
      archive_dest_dir: docs
      pr_commit_message: "Archive completed tasks from docs/TASKS.md"
      pr_title: "Archive completed tasks from docs/TASKS.md"
      pr_body: |
        Automated tasks archive update.

        Archive payloads were pushed to the task-archives branch.
      pr_branch: automation/tasks-archive
      enable_auto_merge: true
    secrets:
      pr_token: ${{ secrets.ARCHIVE_AUTOMERGE_TOKEN }}
