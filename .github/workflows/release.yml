name: release

on:
  push:
    tags:
      - 'v*.*.*'
      - 'v*.*.*-alpha.*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-release:
    runs-on: ubuntu-latest
    outputs:
      tarball: ${{ steps.pack.outputs.tarball }}
      dist_tag: ${{ steps.meta.outputs.dist_tag }}
      prerelease: ${{ steps.meta.outputs.prerelease }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org/

      - name: Resolve release metadata
        id: meta
        run: |
          TAG="${GITHUB_REF_NAME}"
          if [[ "${TAG}" == *"-alpha."* ]]; then
            echo "dist_tag=alpha" >> "$GITHUB_OUTPUT"
            echo "prerelease=true" >> "$GITHUB_OUTPUT"
          else
            echo "dist_tag=latest" >> "$GITHUB_OUTPUT"
            echo "prerelease=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Ensure tag matches package version
        run: |
          TAG_VERSION="${GITHUB_REF_NAME#v}"
          PKG_VERSION=$(node -e "const pkg=require('./package.json'); console.log(pkg.version);")
          if [[ "${TAG_VERSION}" != "${PKG_VERSION}" ]]; then
            echo "Tag ${GITHUB_REF_NAME} does not match package.json version ${PKG_VERSION}" >&2
            exit 1
          fi

      - run: npm ci
      - run: npm run clean:dist
      - run: npm run build
      - run: npm run pack:audit
      - run: npm run pack:smoke

      - name: Create tarball
        id: pack
        run: |
          PACK_JSON=$(npm pack --json --ignore-scripts)
          echo "$PACK_JSON" > pack.json
          TARBALL=$(node -e "const data=require('./pack.json'); const record=Array.isArray(data)?data[0]:data; console.log(record.filename);")
          echo "tarball=${TARBALL}" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${GITHUB_REF_NAME}"
          FLAGS=""
          if [[ "${{ steps.meta.outputs.prerelease }}" == "true" ]]; then
            FLAGS="--prerelease"
          fi
          gh release create "$TAG" "${{ steps.pack.outputs.tarball }}" \
            --repo "${GITHUB_REPOSITORY}" \
            --title "$TAG" \
            --generate-notes \
            $FLAGS

      - name: Upload tarball artifact (fallback)
        uses: actions/upload-artifact@v4
        with:
          name: release-tarball
          path: ${{ steps.pack.outputs.tarball }}

  publish:
    needs: build-release
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    env:
      TAG: ${{ github.ref_name }}
      DIST_TAG: ${{ needs.build-release.outputs.dist_tag }}
      TARBALL_NAME: ${{ needs.build-release.outputs.tarball }}
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org/

      - name: Download release asset with gh (preferred)
        id: gh-download
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set +e
          mkdir -p release-assets
          for attempt in 1 2 3; do
            gh release download "$TAG" --repo "$GITHUB_REPOSITORY" --pattern "*.tgz" --dir release-assets
            status=$?
            if [[ $status -eq 0 ]]; then
              echo "downloaded=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            sleep $((attempt * 2))
          done
          echo "downloaded=false" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Resolve asset id (fallback)
        if: steps.gh-download.outputs.downloaded != 'true'
        id: asset
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const tag = process.env.TAG;
            const release = await github.rest.repos.getReleaseByTag({ owner, repo, tag });
            const asset = release.data.assets.find(item => item.name.endsWith('.tgz'));
            if (!asset) {
              core.setFailed('No .tgz release asset found.');
              return;
            }
            core.setOutput('asset_id', String(asset.id));
            core.setOutput('asset_name', asset.name);

      - name: Download release asset with curl (fallback)
        if: steps.gh-download.outputs.downloaded != 'true' && steps.asset.outputs.asset_id
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          mkdir -p release-assets
          curl -L \
            -H "Accept: application/octet-stream" \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -o "release-assets/${{ steps.asset.outputs.asset_name }}" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/assets/${{ steps.asset.outputs.asset_id }}"

      - name: Download artifact from build (last resort)
        if: steps.gh-download.outputs.downloaded != 'true'
        uses: actions/download-artifact@v4
        with:
          name: release-tarball
          path: release-assets

      - name: Publish to npm
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          TARBALL_PATH=$(ls release-assets/*.tgz | head -n 1)
          if [[ -z "$TARBALL_PATH" ]]; then
            echo "No tarball found to publish." >&2
            exit 1
          fi
          if [[ "$TARBALL_PATH" != /* ]]; then
            TARBALL_PATH="$(pwd)/${TARBALL_PATH}"
          fi
          if [[ -n "${NODE_AUTH_TOKEN}" ]]; then
            npm publish "$TARBALL_PATH" --tag "$DIST_TAG"
          else
            npm publish "$TARBALL_PATH" --tag "$DIST_TAG" --provenance
          fi
