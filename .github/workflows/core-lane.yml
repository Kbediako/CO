name: Core Lane (Build / Lint / Test / Spec Guard)

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  core-lane:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history for diffs)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Node 20 LTS matches the repoâ€™s TypeScript/@types/node baseline and local developer guidance.
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Set BASE_SHA from PR base
        if: ${{ github.event_name == 'pull_request' }}
        run: echo "BASE_SHA=${{ github.event.pull_request.base.sha }}" >> "$GITHUB_ENV"

      - name: Resolve diff-budget override (label + reason)
        if: ${{ github.event_name == 'pull_request' }}
        env:
          DIFF_BUDGET_OVERRIDE_LABEL: diff-budget-override
        run: |
          node - <<'NODE'
          const fs = require('fs');

          const labelName = process.env.DIFF_BUDGET_OVERRIDE_LABEL;
          const eventPath = process.env.GITHUB_EVENT_PATH;
          if (!labelName || !eventPath) {
            process.exit(0);
          }

          const event = JSON.parse(fs.readFileSync(eventPath, 'utf8'));
          const pullRequest = event.pull_request;
          if (!pullRequest) {
            process.exit(0);
          }

          const labels = Array.isArray(pullRequest.labels)
            ? pullRequest.labels.map((label) => String(label?.name ?? '')).filter(Boolean)
            : [];
          if (!labels.includes(labelName)) {
            process.exit(0);
          }

          const body = String(pullRequest.body ?? '');
          const prefix = 'Diff budget override:';
          let reason = '';
          for (const rawLine of body.split(/\r?\n/)) {
            const line = rawLine.trim();
            if (line.startsWith(prefix)) {
              reason = line.slice(prefix.length).trim();
              break;
            }
          }

          if (!reason) {
            console.error(`Diff budget override label "${labelName}" is present, but no non-empty reason was found.`);
            console.error('Add this single line to the PR description:');
            console.error('  Diff budget override: <reason>');
            process.exit(1);
          }

          const envFile = process.env.GITHUB_ENV;
          if (envFile) {
            fs.appendFileSync(envFile, `DIFF_BUDGET_OVERRIDE_REASON<<EOF\n${reason}\nEOF\n`);
          }

          const summaryFile = process.env.GITHUB_STEP_SUMMARY;
          if (summaryFile) {
            fs.appendFileSync(
              summaryFile,
              `### Diff budget override\n\nLabel: \`${labelName}\`\n\nReason: ${reason}\n`
            );
          }

          console.log(`Diff budget override enabled: ${reason}`);
          NODE

      - name: Diff budget
        if: ${{ github.event_name == 'pull_request' }}
        run: node scripts/diff-budget.mjs

      - name: Instruction stamp check
        run: node scripts/update-instruction-stamp.mjs --check

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Lint
        run: npm run lint

      - name: Test
        run: npm run test

      - name: Docs hygiene
        run: npm run docs:check

      - name: Spec guard
        run: node scripts/spec-guard.mjs
