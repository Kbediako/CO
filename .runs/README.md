# Run Artifacts Directory

This directory stores per-task run manifests, transient logs, and reviewer-facing telemetry generated by the Codex Orchestrator CLI.

## Layout

- `.runs/<task-id>/cli/<run-id>/` — canonical artifact root for CLI executions (task id defaults to `MCP_RUNNER_TASK_ID` or `0101`). Each run contains:
  - `manifest.json` — per-command status, heartbeat metadata, resume token, metrics bookkeeping (`metrics_recorded`), and run-level summary guidance (diagnostics recommendations when guardrails are missing or failing).
  - `runner.ndjson` — aggregated stdout/stderr events from the CLI run (one JSON object per line).
  - `.heartbeat` — last heartbeat timestamp written every 10 seconds while the runner is active.
  - `.resume-token` — the 32-byte token required by `codex-orchestrator resume --run <run-id>` to reattach to a run.
  - `commands/<index>-<slug>.ndjson` — command-level streaming logs captured as newline-delimited JSON.
  - `errors/<index>-<slug>.json` — structured failure artifacts with raw tool payloads and summaries when commands return malformed responses or non-zero exit codes (referenced via `manifest.commands[].error_file`).
- `.runs/<task-id>/mcp/<run-id>/` — compatibility pointer re-created during each run/migration for downstream tooling that still expects the legacy MCP hierarchy.
- `.runs/local-mcp/<run-id>/` — legacy artifacts (read-only) retained for historical MCP runs; new CLI runs populate compatibility stubs only.
- `.runs/<task-id>/metrics.json` — JSON Lines stream appended after each run reaches a terminal state (success/failure/cancelled).
- `.runs/<task-id>/metrics-summary.json` — aggregate statistics generated via `scripts/mcp-runner-metrics.js` (success rate, average duration, guardrail coverage).
- `.runs/<task-id>/migrations/<timestamp>.log` — audit records produced by `scripts/mcp-runner-migrate.js` in either dry-run or execution mode when migrating legacy artifacts.

## Notes

- All timestamps are stored in ISO 8601 format; heartbeat staleness is derived from `manifest.heartbeat_at` with a 30 second threshold.
- The CLI refuses to start if it cannot write both the task-scoped artifact root and the compatibility pointer.
- Resume events are tracked in `manifest.resume_events[]` with actor/reason metadata to help reviewers trace handoffs.
- Failed commands produce dedicated error artifacts under `errors/` so reviewers can inspect malformed payloads without replaying the run.
- When the spec-guard command is missing or fails, the CLI logs a recommendation to rerun diagnostics and records the guidance in `manifest.summary` for reviewer follow-through.
- Use `codex-orchestrator start diagnostics --format json --no-interactive` and `codex-orchestrator status --run <run-id> --watch --interval 10` to capture and follow diagnostics.
- Reviewers should cite the metrics summary alongside the specific run manifest when validating checklist entries.
