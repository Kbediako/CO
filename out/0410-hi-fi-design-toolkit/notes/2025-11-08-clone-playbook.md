# Hi-Fi Clone README — 2025-11-08

## Config switches for pixel-faithful clones
- Enable `pipelines.hi_fi_design_toolkit` in `design.config.yaml` per spec (§3.1) with explicit `sources[]`, breakpoints, mask selectors, and retention overrides so the hi-fi path mirrors the design-reference opt-in semantics.
- Export `MCP_RUNNER_TASK_ID=0410-hi-fi-design-toolkit` and launch runs with `npx codex-orchestrator start diagnostics --pipeline hi-fi-design-toolkit --format json` (or set `DESIGN_PIPELINE=1` / `DESIGN_TOOLKIT=1`) so manifests and guardrails route artifacts into `.runs/0410-hi-fi-design-toolkit/**`.
- Each source needs a `live_assets` block when motion parity matters; Soil Net kept `keep_scripts=true` and bumped `max_stylesheets=24` so carousels + sticky nav stay intact while serving from `context/<slug>/assets/**` (docs/design/specs/HI_FI_DESIGN_TOOLKIT.md:23-30, 133-135; out/0410-hi-fi-design-toolkit/notes/2025-11-07-soil-net.md:13).
- Pipeline will fail fast unless a matching entry exists in `compliance/permit.json`; permits such as `soil-net-2025-11-07` must cover Playwright, optional video/FFmpeg, and any remote self-correction provider id so manifest approvals satisfy the matrix (docs/design/specs/HI_FI_DESIGN_TOOLKIT.md:33-34, 79-85; out/0410-hi-fi-design-toolkit/notes/2025-11-07-soil-net.md:14).
- Toggling `self_correction.enabled`, `self_correction.provider`, and FFmpeg quotas controls whether the reference stage emits diff images/video; approvals for these flags must be mirrored in `.runs/.../manifest.json` before designers flip checklists (docs/design/specs/HI_FI_DESIGN_TOOLKIT.md:52-67).
- Guard every config touch with `node scripts/spec-guard.mjs --dry-run`; attach the resulting manifest path to `/tasks` and docs checklists to keep the run of record auditable (docs/design/specs/HI_FI_DESIGN_TOOLKIT.md:109-112).

## Stages needed for a “perfect clone”
1. **Context acquisition** — `scripts/design/pipeline/toolkit/extract.ts` snapshots each source/breakpoint, rewrites remote URLs to stable local paths, and writes `context/<slug>/{computed.json, inline.html, assets/**}` plus `sections.json` & `palette.json`. Ensure mask selectors scrub sensitive fragments before mirroring; the Soil Net run verified offline parity with `npx serve <context>/soil-net -l 4173` (docs/design/specs/HI_FI_DESIGN_TOOLKIT.md:33-44, out/0410-hi-fi-design-toolkit/notes/2025-11-07-soil-net.md:13).
2. **Tokenization + style guide** — `scripts/design/pipeline/toolkit/tokens.ts` orchestrates the CSS-to-token extraction plus the `pnpm -C tools/styleguide build` call, emitting `tokens/<slug>/tokens.json` and `styleguide/<slug>/`. DOM/CSS capture seeds IBM Plex–based stacks plus 12-color palettes; designers should extend semantic aliases (`cta`, `surface`, `border`) before publish (docs/design/specs/HI_FI_DESIGN_TOOLKIT.md:41-45, 123-125).
3. **Reference + self-correction** — `reference.ts` renders `reference/<slug>/index.html` while keeping a single-source-of-truth `inline.html` inside the context folder for quick QA. Optional `self_correction.enabled=true` loops produce diff screenshots/video in `diffs/<slug>` once FFmpeg + approvals are toggled; keep manifest metrics (`error_rate_before/after`) fresh (docs/design/specs/HI_FI_DESIGN_TOOLKIT.md:52-66).
4. **Toolkit publish** — `publish.ts` copies sanitized tokens into `packages/design-system/tokens/src/hi-fi/<slug>.json`, scaffolds components, and runs `npm --prefix packages/design-system run build:tokens && run lint && run test:visual` so the downstream library ships a faithful clone (docs/design/specs/HI_FI_DESIGN_TOOLKIT.md:57-67).

## Remaining gaps & watch-outs
- Manifest-only evidence: heavy artifacts were purged, so cite `.runs/0410-hi-fi-design-toolkit/cli/2025-11-07T08-50-51-966Z-c2554f30/manifest.json` (Cognition) or `.runs/0410-hi-fi-design-toolkit/cli/2025-11-07T12-41-35-270Z-1f9139d2/manifest.json` when referencing historical runs until new captures regenerate assets (docs/design/specs/HI_FI_DESIGN_TOOLKIT.md:117-133, out/0410-hi-fi-design-toolkit/notes/2025-11-07-soil-net.md:2).
- Section detection still collapses complex layouts into single blocks; gradients, shadows, and animation masks (especially canvas/video) need extractor updates before clones feel perfect (docs/design/specs/HI_FI_DESIGN_TOOLKIT.md:124-134).
- Semantic aliases default to palette slots; Soil Net highlights the need to derive `cta`, `surface`, and `border` tokens plus add localization metadata for Japanese copy before shipping (out/0410-hi-fi-design-toolkit/notes/2025-11-07-soil-net.md:21-23; docs/design/specs/HI_FI_DESIGN_TOOLKIT.md:136).
- Video mirroring remains off even though permits now allow it; enable FFmpeg cautiously after verifying quotas and privacy notes, otherwise carousel parity depends solely on script replay (docs/design/specs/HI_FI_DESIGN_TOOLKIT.md:134; out/0410-hi-fi-design-toolkit/notes/2025-11-07-soil-net.md:14).
- Map overlays/iframes require explicit mask selectors (`.map` containers from Soil Net) so future publishes do not retain live tile feeds (out/0410-hi-fi-design-toolkit/notes/2025-11-07-soil-net.md:24-27).

## Designer iteration workflow
1. **Locate artifacts** — Once a run completes, pull the timestamped folder under `.runs/0410-hi-fi-design-toolkit/<run-id>/artifacts/design-toolkit/` and note the manifest path inside `.runs/.../cli/<run-id>/manifest.json` for checklists.
2. **Preview offline** — Serve `context/<slug>/inline.html` (or the `reference/<slug>/index.html` surrogate) with `npx serve .runs/.../context/<slug> -l 4173` to validate motion + masking without touching the live site (mirrors Soil Net practice).
3. **Update tokens + style guide** — Edit `tokens/<slug>/tokens.json`, regenerate the style guide via `pnpm -C tools/styleguide build --tokens tokens/<slug>/tokens.json --out styleguide/<slug>`, and document semantic alias decisions in `out/0410-hi-fi-design-toolkit/notes/<date>-<slug>.md`.
4. **Check privacy & permits** — Confirm mask selectors in `design.config.yaml` still suppress PII, ensure the permit entry lists every capture mode (Playwright, live assets, video, remote providers), and keep approvals in sync with manifest `approvals[]`.
5. **Prepare publish evidence** — When satisfied, run the toolkit publish stage to push tokens/components into `packages/design-system`, then log lint/test/visual outputs plus manifest IDs in `.runs/**` and `/tasks` before requesting review.

## Pre-publish checklist
- [ ] Config: `pipelines.hi_fi_design_toolkit.sources[]` entry updated with correct breakpoints, live asset toggles, and mask selectors; guard manifest attached.
- [ ] Permits: matching `compliance/permit.json` entry (e.g., `soil-net-2025-11-07`) covers Playwright, live assets, FFmpeg/self-correction providers; approval ids recorded in manifest.
- [ ] Context parity: `context/<slug>/inline.html` served locally without remote calls; `sections.json` + `palette.json` capture hero/content modules accurately.
- [ ] Tokens/style guide: `tokens/<slug>/tokens.json` includes semantic aliases (`cta`, `surface`, `border`) and localization notes; regenerated style guide reviewed.
- [ ] Reference/self-correction: screenshot/video diffs (if enabled) stored under `diffs/<slug>` with error-rate metrics; unresolved animation masks documented.
- [ ] Publish readiness: `publish.ts` outputs queued, `npm --prefix packages/design-system run build:tokens | lint | test:visual` all green, and the manifest path is cited in `/tasks` + `out/0410-hi-fi-design-toolkit/notes/`.
